


<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex/" /><link rel="search" title="Search" href="../../search/" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2024.01.29 -->
        <title>soundit - soundit 0.4 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=cdd7e7c4" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../" title="soundit 0.4 documentation"><div class="brand">soundit 0.4 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../">
  
  
  <span class="sidebar-brand-text">soundit 0.4 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search/" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api/">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/soundit/">soundit</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog/">Changelog</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container"><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for soundit</h1><div class="highlight"><pre>
<span></span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Make audio</span>

<span class="sd">This module uses iterators to represent audio streams. These iterators return</span>
<span class="sd">float values between [-1.0, 1.0) and can be chained, averaged, and precomputed</span>
<span class="sd">to your heart&#39;s content to create music. We call these iterators &quot;sounds&quot;.</span>

<span class="sd">Note that all sounds are in 48kHz.</span>

<span class="sd">There is also a kinda sus music parser which can aid in creating longer music.</span>
<span class="sd">More info on that can be found in the `music_to_notes`&#39;s docstring.</span>

<span class="sd">Sound generators:</span>
<span class="sd">    `sine`</span>
<span class="sd">    `square`</span>
<span class="sd">    `sawtooth`</span>
<span class="sd">    `triangle`</span>
<span class="sd">    `silence`</span>
<span class="sd">    `piano`  (requires `init_piano` to be called)</span>

<span class="sd">Sound creation utilities:</span>
<span class="sd">    `passed`</span>

<span class="sd">Sound effects:</span>
<span class="sd">    `fade`</span>
<span class="sd">    `volume`</span>
<span class="sd">    `cut`</span>
<span class="sd">    `pad`</span>
<span class="sd">    `exact`</span>
<span class="sd">    `delay`</span>

<span class="sd">Frequency utilities:</span>
<span class="sd">    `make_frequencies_dict`</span>
<span class="sd">    `make_indices_dict`</span>

<span class="sd">Music functions:</span>
<span class="sd">    `split_music`</span>
<span class="sd">    `music_to_notes`</span>
<span class="sd">    `notes_to_sine`</span>
<span class="sd">    `_notes_to_sound`  (unfinalized API)</span>

<span class="sd">Audio source utilities:</span>
<span class="sd">    `chunked`</span>
<span class="sd">    `unchunked`</span>

<span class="sd">We also provide some utility functions with other tools such as converting</span>
<span class="sd">chunks into discord.py AudioSources or decompressing audio on the fly with</span>
<span class="sd">FFmpeg. These only work when their required library is installed.</span>

<span class="sd">discord.py utilities:</span>
<span class="sd">    `wrap_discord_source`</span>
<span class="sd">    `unwrap_discord_source`</span>
<span class="sd">    `play_discord_source`</span>

<span class="sd">FFmpeg utilities:</span>
<span class="sd">    `file_chunks`</span>
<span class="sd">    `make_ffmpeg_section_args`</span>
<span class="sd">    `create_ffmpeg_process`</span>
<span class="sd">    `chunked_ffmpeg_process`</span>

<span class="sd">sounddevice utilities:</span>
<span class="sd">    `play_output_chunks`</span>
<span class="sd">    `create_input_chunks`</span>

<span class="sd">There is also some built-in music that are prefixed with \MUSIC_, such as</span>
<span class="sd">MUSIC_DIGITIZED, provided for testing purposes.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">heapq</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">cmath</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">discord</span>  <span class="c1"># type: ignore</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
<div class="viewcode-block" id="has_discord">
<a class="viewcode-back" href="../../api/soundit/#soundit.has_discord">[docs]</a>
    <span class="n">has_discord</span> <span class="o">=</span> <span class="kc">False</span></div>

<span class="k">else</span><span class="p">:</span>
    <span class="n">has_discord</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sounddevice</span>  <span class="c1"># type: ignore</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
<div class="viewcode-block" id="has_sounddevice">
<a class="viewcode-back" href="../../api/soundit/#soundit.has_sounddevice">[docs]</a>
    <span class="n">has_sounddevice</span> <span class="o">=</span> <span class="kc">False</span></div>

<span class="k">else</span><span class="p">:</span>
    <span class="n">has_sounddevice</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">av</span>  <span class="c1"># type: ignore</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
<div class="viewcode-block" id="has_av">
<a class="viewcode-back" href="../../api/soundit/#soundit.has_av">[docs]</a>
    <span class="n">has_av</span> <span class="o">=</span> <span class="kc">False</span></div>

<span class="k">else</span><span class="p">:</span>
    <span class="n">has_av</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">numpy</span>  <span class="c1"># type: ignore</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
<div class="viewcode-block" id="has_numpy">
<a class="viewcode-back" href="../../api/soundit/#soundit.has_numpy">[docs]</a>
    <span class="n">has_numpy</span> <span class="o">=</span> <span class="kc">False</span></div>

<span class="k">else</span><span class="p">:</span>
    <span class="n">has_numpy</span> <span class="o">=</span> <span class="kc">True</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Deque</span><span class="p">,</span> <span class="n">Iterator</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Literal</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeAlias</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">TypeAlias</span>

<span class="c1"># - Constants</span>

<div class="viewcode-block" id="RATE">
<a class="viewcode-back" href="../../api/soundit/#soundit.RATE">[docs]</a>
<span class="n">RATE</span> <span class="o">=</span> <span class="mi">48000</span>  <span class="c1"># 48kHz</span></div>

<div class="viewcode-block" id="A4_FREQUENCY">
<a class="viewcode-back" href="../../api/soundit/#soundit.A4_FREQUENCY">[docs]</a>
<span class="n">A4_FREQUENCY</span> <span class="o">=</span> <span class="mi">440</span></div>

<div class="viewcode-block" id="A4_INDEX">
<a class="viewcode-back" href="../../api/soundit/#soundit.A4_INDEX">[docs]</a>
<span class="n">A4_INDEX</span> <span class="o">=</span> <span class="mi">57</span></div>

<div class="viewcode-block" id="NOTE_NAMES">
<a class="viewcode-back" href="../../api/soundit/#soundit.NOTE_NAMES">[docs]</a>
<span class="n">NOTE_NAMES</span> <span class="o">=</span> <span class="s2">&quot;c c# d d# e f f# g g# a a# b&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span></div>



<span class="c1"># - Numpy iterators</span>

<span class="k">if</span> <span class="n">has_numpy</span><span class="p">:</span>
    <span class="c1"># Convert sound iterator to numpy iterator</span>
    <span class="k">def</span> <span class="nf">_to_numpy</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="s2">&quot;_as_numpy_iterator&quot;</span><span class="p">):</span>
            <span class="n">iterator</span> <span class="o">=</span> <span class="n">_NumpyConvertibleIterator</span><span class="o">.</span><span class="n">_from_sound</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">iterator</span><span class="o">.</span><span class="n">_as_numpy_iterator</span><span class="p">()</span>

    <span class="c1"># Ensure iterator is a sound (assumes argument isn&#39;t a numpy iterator)</span>
    <span class="k">def</span> <span class="nf">_ensure_sound</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="s2">&quot;_as_numpy_iterator&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">iterator</span><span class="o">.</span><span class="n">_as_sound_iterator</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">iterator</span>

    <span class="c1"># Can be used to speed up some operations</span>
    <span class="k">class</span> <span class="nc">_NumpyConvertibleIterator</span><span class="p">:</span>
        <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;_running&quot;</span><span class="p">,</span> <span class="s2">&quot;_converted&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_iterator&quot;</span><span class="p">,</span> <span class="s2">&quot;_numpy_iterator&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_name&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterator</span><span class="p">,</span> <span class="n">numpy_iterator</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_converted</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span> <span class="o">=</span> <span class="n">iterator</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_numpy_iterator</span> <span class="o">=</span> <span class="n">numpy_iterator</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;sound=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span><span class="si">!r}</span><span class="s1">&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="k">else</span>
                <span class="sa">f</span><span class="s1">&#39;numpy=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_numpy_iterator</span><span class="si">!r}</span><span class="s1">&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_converted</span> <span class="k">else</span>
                <span class="sa">f</span><span class="s1">&#39;unconverted name=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="si">!r}</span><span class="s1">&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span>
                <span class="s2">&quot;unconverted&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1">&gt;&#39;</span>

        <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_converted</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;cannot iterate converted iterator&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_converted</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_numpy_iterator</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="c1"># Getting an attribute on an unconverted iterator sets it running</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_converted</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_as_numpy_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_converted</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;cannot convert running iterator&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_numpy_iterator</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_numpy_iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numpy_iterator</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_converted</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numpy_iterator</span>

        <span class="k">def</span> <span class="nf">_as_sound_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_converted</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;iterator already converted&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">_numpy_from_sound</span><span class="p">(</span><span class="n">iterator</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">):</span>
            <span class="n">CHUNK_SIZE</span> <span class="o">=</span> <span class="n">RATE</span> <span class="o">//</span> <span class="mi">50</span>
            <span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>  <span class="c1"># iterator could actually be an iterable</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span>
                    <span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">CHUNK_SIZE</span><span class="p">),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="n">array</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">CHUNK_SIZE</span><span class="p">:</span>
                    <span class="k">return</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">_sound_from_numpy</span><span class="p">(</span><span class="n">numpy_iterator</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">numpy_iterator</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">array</span>

        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">_from_sound</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">iterator</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
                <span class="n">iterator</span><span class="p">,</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_numpy_from_sound</span><span class="p">(</span><span class="n">iterator</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="n">iterator</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">_from_numpy</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">numpy_iterator</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_sound_from_numpy</span><span class="p">(</span><span class="n">numpy_iterator</span><span class="p">),</span>
                <span class="n">numpy_iterator</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">numpy_iterator</span><span class="p">,</span>
            <span class="p">)</span>

<span class="c1"># Main decorator interface for _NumpyConvertibleIterator compatible functions</span>
<span class="k">def</span> <span class="nf">_convertible</span><span class="p">(</span><span class="n">sound_func</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">has_numpy</span><span class="p">:</span>
        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">sound_func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_NumpyConvertibleIterator</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">func</span><span class="o">.</span><span class="n">_sound_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">func</span><span class="o">.</span><span class="n">_numpy_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">_sound_func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">_wrapper</span>
        <span class="n">func</span><span class="o">.</span><span class="n">_sound_func</span> <span class="o">=</span> <span class="n">sound_func</span>
        <span class="k">def</span> <span class="nf">_missing_numpy_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;missing numpy function: </span><span class="si">{</span><span class="n">sound_func</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">func</span><span class="o">.</span><span class="n">_numpy_func</span> <span class="o">=</span> <span class="n">_missing_numpy_func</span>
        <span class="n">func</span><span class="o">.</span><span class="n">_supports_numpy</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">sound_func</span>

    <span class="k">def</span> <span class="nf">_as_numpy_decorate</span><span class="p">(</span><span class="n">numpy_func</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">numpy_func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">sound_func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">warnings</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;numpy function has same name as sound function:&quot;</span>
                <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">numpy_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">func</span><span class="o">.</span><span class="n">_numpy_func</span> <span class="o">=</span> <span class="n">numpy_func</span>
        <span class="k">return</span> <span class="n">numpy_func</span>
    <span class="n">func</span><span class="o">.</span><span class="n">_as_numpy</span> <span class="o">=</span> <span class="n">_as_numpy_decorate</span>

    <span class="k">return</span> <span class="n">func</span>


<span class="c1"># - Sound generators</span>

<span class="nd">@_convertible</span>
<div class="viewcode-block" id="silence">
<a class="viewcode-back" href="../../api/soundit/#soundit.silence">[docs]</a>
<span class="k">def</span> <span class="nf">silence</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns silence&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">passed</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">yield</span> <span class="mf">0.0</span></div>


<span class="nd">@silence</span><span class="o">.</span><span class="n">_as_numpy</span>
<span class="k">def</span> <span class="nf">_numpy_silence</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">passed</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
        <span class="n">x</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">x</span>

<span class="nd">@_convertible</span>
<div class="viewcode-block" id="sine">
<a class="viewcode-back" href="../../api/soundit/#soundit.sine">[docs]</a>
<span class="k">def</span> <span class="nf">sine</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">A4_FREQUENCY</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a sine wave at freq&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">passed</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">freq</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span></div>


<span class="nd">@sine</span><span class="o">.</span><span class="n">_as_numpy</span>
<span class="k">def</span> <span class="nf">_numpy_sine</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">A4_FREQUENCY</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">passed</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
        <span class="k">yield</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">freq</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>

<span class="nd">@_convertible</span>
<div class="viewcode-block" id="square">
<a class="viewcode-back" href="../../api/soundit/#soundit.square">[docs]</a>
<span class="k">def</span> <span class="nf">square</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">A4_FREQUENCY</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a square wave at freq&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">passed</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">freq</span><span class="o">*</span><span class="n">x</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span></div>


<span class="nd">@square</span><span class="o">.</span><span class="n">_as_numpy</span>
<span class="k">def</span> <span class="nf">_numpy_square</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">A4_FREQUENCY</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">passed</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">freq</span><span class="o">*</span><span class="n">x</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>

<span class="nd">@_convertible</span>
<div class="viewcode-block" id="sawtooth">
<a class="viewcode-back" href="../../api/soundit/#soundit.sawtooth">[docs]</a>
<span class="k">def</span> <span class="nf">sawtooth</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">A4_FREQUENCY</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a sawtooth wave at freq&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">passed</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">yield</span> <span class="p">((</span><span class="n">freq</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span></div>


<span class="nd">@sawtooth</span><span class="o">.</span><span class="n">_as_numpy</span>
<span class="k">def</span> <span class="nf">_numpy_sawtooth</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">A4_FREQUENCY</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">passed</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
        <span class="k">yield</span> <span class="p">((</span><span class="n">freq</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>

<span class="nd">@_convertible</span>
<div class="viewcode-block" id="triangle">
<a class="viewcode-back" href="../../api/soundit/#soundit.triangle">[docs]</a>
<span class="k">def</span> <span class="nf">triangle</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">A4_FREQUENCY</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a triangle wave at freq&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">passed</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">yield</span> <span class="p">(</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">freq</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span></div>


<span class="nd">@triangle</span><span class="o">.</span><span class="n">_as_numpy</span>
<span class="k">def</span> <span class="nf">_numpy_triangle</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">A4_FREQUENCY</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">passed</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
        <span class="k">yield</span> <span class="p">(</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">freq</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>

<div class="viewcode-block" id="piano_data">
<a class="viewcode-back" href="../../api/soundit/#soundit.piano_data">[docs]</a>
<span class="n">piano_data</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="init_piano">
<a class="viewcode-back" href="../../api/soundit/#soundit.init_piano">[docs]</a>
<span class="k">def</span> <span class="nf">init_piano</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads the piano sound for use</span>

<span class="sd">    The raw file 0.raw was generated from Online Sequencer&#39;s Electric Piano</span>
<span class="sd">    instrument (from https://onlinesequencer.net/app/instruments/0.ogg?v=12)</span>
<span class="sd">    and FFmpeg was then used to convert it into a raw mono 48kHz signed 16-bit</span>
<span class="sd">    little endian file (using ffmpeg -i 0.ogg -f s16le -acodec pcm_s16le -ac 1</span>
<span class="sd">    -ar 48000 0.raw).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">piano_data</span>
    <span class="k">if</span> <span class="n">piano_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;0.raw&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">piano_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>


<span class="nd">@_convertible</span>
<div class="viewcode-block" id="piano">
<a class="viewcode-back" href="../../api/soundit/#soundit.piano">[docs]</a>
<span class="k">def</span> <span class="nf">piano</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">A4_INDEX</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a piano sound at index&quot;&quot;&quot;</span>
    <span class="n">index</span> <span class="o">-=</span> <span class="mi">2</span><span class="o">*</span><span class="mi">12</span>  <span class="c1"># The piano starts at C2</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">passed</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">index</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">RATE</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">yield</span> <span class="p">(</span>
            <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">piano_data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;little&quot;</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span></div>


<span class="nd">@piano</span><span class="o">.</span><span class="n">_as_numpy</span>
<span class="k">def</span> <span class="nf">_numpy_piano</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">A4_INDEX</span><span class="p">):</span>
    <span class="n">_numpy_piano_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">piano_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;&lt;h&quot;</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">-=</span> <span class="mi">2</span><span class="o">*</span><span class="mi">12</span>  <span class="c1"># The piano starts at C2</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">passed</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="p">((</span><span class="n">index</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">RATE</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">_numpy_piano_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<span class="c1"># - Simple file API</span>

<div class="viewcode-block" id="file_chunks">
<a class="viewcode-back" href="../../api/soundit/#soundit.file_chunks">[docs]</a>
<span class="k">def</span> <span class="nf">file_chunks</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a sound from an audio file using FFmpeg</span>

<span class="sd">    Arguments:</span>
<span class="sd">        filename: path to the audio file</span>
<span class="sd">        start: seconds into the audio to start at</span>

<span class="sd">    Returns:</span>
<span class="sd">        stream of two-tuples of floats decoded from the audio file</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">has_av</span><span class="p">:</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">_chunked_libav_section</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="n">equal_chunk_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">RATE</span><span class="o">//</span><span class="mi">50</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">unchunked</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">make_ffmpeg_section_args</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">process</span> <span class="o">=</span> <span class="n">create_ffmpeg_process</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="n">chunked_ffmpeg_process</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unchunked</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span></div>



<span class="c1"># - Experimental sounds from Online Sequencer</span>

<span class="k">class</span> <span class="nc">_OSUtils</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Utilities to work with Online Sequencer instruments</span>

<span class="sd">    The audio is assumed to be Online Sequencer&#39;s instrument files of the form</span>
<span class="sd">    :samp:`https://onlinesequencer.net/app/instruments/{instrument index}.ogg?v=12`.</span>
<span class="sd">    Instruments vary from 1-43, with 13-16 being 8-bit sounds (sine, square,</span>
<span class="sd">    sawtooth, and triangle respectively) and 41 and 43 being the length</span>
<span class="sd">    dependent classic and grand piano respectively. The settings are assumed to</span>
<span class="sd">    be from</span>
<span class="sd">    :samp:`https://onlinesequencer.net/resources/c/{some hash}.js`. An example</span>
<span class="sd">    hash is ``85dda66875c37703d44f50da0bb85185``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Online Sequencer starts from C2 (two octaves)</span>
    <span class="n">_INDEX_OFFSET</span> <span class="o">=</span> <span class="mi">24</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">section_of</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return section info for the specified note</span>

<span class="sd">        Arguments:</span>
<span class="sd">            settings: settings from Online Sequencer JS script</span>
<span class="sd">            instrument: instrument index</span>
<span class="sd">            index: note index</span>

<span class="sd">        Returns:</span>
<span class="sd">            two-tuple with start and length, both floats and in seconds</span>

<span class="sd">        Raises:</span>
<span class="sd">            LookupError: if index is out of the instrument&#39;s range</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lo</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">][</span><span class="n">instrument</span><span class="p">]</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_INDEX_OFFSET</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">][</span><span class="n">instrument</span><span class="p">]</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_INDEX_OFFSET</span>
        <span class="n">bpm</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;originalBpm&quot;</span><span class="p">][</span><span class="n">instrument</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># BPM is 2x stored one</span>
        <span class="n">length</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">/</span> <span class="n">bpm</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lo</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="n">hi</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="n">lo</span><span class="p">)</span> <span class="o">*</span> <span class="n">length</span><span class="p">,</span> <span class="n">length</span>

<span class="k">class</span> <span class="nc">_OSInstrument</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An instrument wrapping a collection of sounds</span>

<span class="sd">    These sounds are taken from Online Sequencer. The audio is from links of</span>
<span class="sd">    the form ``https://onlinesequencer.net/app/instruments/&lt;&gt;.ogg?v=12`` with</span>
<span class="sd">    ``&lt;&gt;`` being replaced with the instrument number. The settings are from</span>
<span class="sd">    https://onlinesequencer.net/resources/c/85dda66875c37703d44f50da0bb85185.js.</span>

<span class="sd">    Online Sequencer&#39;s lowest note index (0) represents a C2, which would be 24</span>
<span class="sd">    according to make_indices_dict. All note indices are offset accordingly.</span>

<span class="sd">    Sounds are cached on a per instrument basis with the instrument instance</span>
<span class="sd">    and note index as the key. You can pass your own cache if necessary. Note</span>
<span class="sd">    that we cache the binary data, not the floats, as this reduces memory usage</span>
<span class="sd">    by a lot (at the cost of some more CPU usage).</span>

<span class="sd">    Note that no FFmpeg preprocessing is needed; all reencoding is done at</span>
<span class="sd">    runtime. However, you can still specify a raw PCM file. Just also pass</span>
<span class="sd">    the relevant FFmpeg options specifying the format, sample rate, and number</span>
<span class="sd">    of channels. For 48 kHz signed 16-bit little endian mono audio, you&#39;d pass</span>
<span class="sd">    ``before_options=[&quot;-f&quot;, &quot;s16le&quot;, &quot;-ar&quot;, &quot;48000&quot;, &quot;-ac&quot;, &quot;1&quot;]``. You may</span>
<span class="sd">    also want to pass ``options=[&quot;-v&quot;, &quot;error&quot;]`` to make FFmpeg quieter (it</span>
<span class="sd">    warns you about estimating the duration from the bitrate).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_SETTINGS_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;onlinesequencer_settings.json&quot;</span>
    <span class="n">_INSTRUMENT_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;./_ossounds/&lt;&gt;.ogg&quot;</span>
    <span class="n">_INDEX_OFFSET</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">12</span>

    <span class="n">_settings</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_cache</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">instrument</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">before_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_cache_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an instrument</span>

<span class="sd">        If the instrument is a string, it is looked up and converted into an</span>
<span class="sd">        instrument number.</span>

<span class="sd">        The filename can optionally have a pair of angle brackets ``&lt;&gt;`` which</span>
<span class="sd">        will be replaced by the instrument number.</span>

<span class="sd">        The before_options and options arguments are included in the</span>
<span class="sd">        .ffmpeg_args_for method&#39;s return value. Note that they will be prefixed</span>
<span class="sd">        by ``[&quot;-ss&quot;, str(start_time)]`` for before_options and</span>
<span class="sd">        ``[&quot;-t&quot;, str(self.seconds)]`` for options.</span>

<span class="sd">        For the sound cache, you can directly pass an LRUIterableCache to the</span>
<span class="sd">        cache keyword argument. Passing max_cache_size is deprecated.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_settings</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">instrument</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;instruments&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">instrument</span><span class="p">)</span>
        <span class="c1"># Store them on the instrument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span> <span class="o">=</span> <span class="n">instrument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instrument_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;instruments&quot;</span><span class="p">][</span><span class="n">instrument</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">][</span><span class="n">instrument</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_INDEX_OFFSET</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">][</span><span class="n">instrument</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_INDEX_OFFSET</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_bpm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;originalBpm&quot;</span><span class="p">][</span><span class="n">instrument</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seconds</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_bpm</span>
        <span class="c1"># Get filename from template if one wasn&#39;t provided</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_INSTRUMENT_FILENAME</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;&gt;&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">instrument</span><span class="p">))</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{i}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">instrument</span><span class="p">))</span>  <span class="c1"># Old template</span>
        <span class="c1"># FFmpeg options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">before_options</span> <span class="o">=</span> <span class="n">before_options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="c1"># Create the cache for source iterators</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">max_cache_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cache</span> <span class="o">=</span> <span class="n">LRUIterableCache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">max_cache_size</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">LRUIterableCache</span><span class="p">()</span>
                <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>

    <span class="c1"># Simple hash (we compare instruments by identity)</span>
    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">A4_INDEX</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a sound at the specified note index</span>

<span class="sd">        Note that the source iterable may be cached. Thus, if the file changes,</span>
<span class="sd">        the returned sounds may not be updated. Use .cache_clear() to refresh</span>
<span class="sd">        the cache.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If the index is out of range, return an empty sound (no points)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_of</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># Check the cache before getting the chunks</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunks_at</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
        <span class="c1"># Unchunk and convert into a sound</span>
        <span class="k">return</span> <span class="n">single</span><span class="p">(</span><span class="n">unchunked</span><span class="p">(</span><span class="n">chunks</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">start_of</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">A4_INDEX</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the start time for the specified note or None if invalid&quot;&quot;&quot;</span>
        <span class="c1"># If the index is out of range, return None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Return the starting time otherwise</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds</span>

    <span class="k">def</span> <span class="nf">ffmpeg_args_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">before_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a list of arguments to FFmpeg</span>

<span class="sd">        It will take the required amount of audio starting from the specified</span>
<span class="sd">        start time and convert them into PCM 16-bit stereo audio to be piped to</span>
<span class="sd">        STDOUT.</span>

<span class="sd">        The instance&#39;s .before_options will be added before the before_options</span>
<span class="sd">        argument and likewise with .options.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;start must be a float&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">before_options</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">before_options</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># Strings are naughty. Force user to split them beforehand</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;FFmpeg options should be lists, not strings&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_ffmpeg_section_args</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
            <span class="n">start</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span>
            <span class="n">before_options</span><span class="o">=</span><span class="p">[</span>
                <span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">before_options</span> <span class="ow">or</span> <span class="p">()),</span>
                <span class="o">*</span><span class="p">(</span><span class="n">before_options</span> <span class="ow">or</span> <span class="p">()),</span>
            <span class="p">],</span>
            <span class="n">options</span><span class="o">=</span><span class="p">[</span>
                <span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="ow">or</span> <span class="p">()),</span>
                <span class="o">*</span><span class="p">(</span><span class="n">options</span> <span class="ow">or</span> <span class="p">()),</span>
            <span class="p">],</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_settings</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_settings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_SETTINGS_FILENAME</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_settings</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_chunks_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
        <span class="c1"># Get FFmpeg arguments</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ffmpeg_args_for</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="c1"># Create the process</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">create_ffmpeg_process</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="c1"># Create a chunks from the process</span>
        <span class="k">return</span> <span class="n">chunked_ffmpeg_process</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cache_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clears the source iterables cache</span>

<span class="sd">        Same as doing .cache.clear().</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="c1"># - LRU cache</span>

<div class="viewcode-block" id="LRUCache">
<a class="viewcode-back" href="../../api/soundit/#soundit.LRUCache">[docs]</a>
<span class="k">class</span> <span class="nc">LRUCache</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An LRU cache</span>

<span class="sd">    Arguments:</span>
<span class="sd">        maxsize: the maximum size of the cache (None means unbounded)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">128</span><span class="p">):</span>
        <span class="c1"># Set cache state</span>
<div class="viewcode-block" id="LRUCache.maxsize">
<a class="viewcode-back" href="../../api/soundit/#soundit.LRUCache.maxsize">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span> <span class="o">=</span> <span class="n">maxsize</span></div>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;The maximum size of the cache</span>

<span class="sd">        0 means that the cache will remain empty. Specifying None means the</span>
<span class="sd">        cache will grow without bound.</span>

<span class="sd">        Note that changes to maxsize won&#39;t take effect until the next `get()`</span>
<span class="sd">        call with a key not in the cache. It is not recommended, but you can</span>
<span class="sd">        call ``._ensure_size()`` to force it to resize the cache.</span>

<span class="sd">        &quot;&quot;&quot;</span>
<div class="viewcode-block" id="LRUCache.hits">
<a class="viewcode-back" href="../../api/soundit/#soundit.LRUCache.hits">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">hits</span> <span class="o">=</span> <span class="mi">0</span></div>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of cache hits&quot;&quot;&quot;</span>
<div class="viewcode-block" id="LRUCache.misses">
<a class="viewcode-back" href="../../api/soundit/#soundit.LRUCache.misses">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">misses</span> <span class="o">=</span> <span class="mi">0</span></div>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of cache misses&quot;&quot;&quot;</span>
<div class="viewcode-block" id="LRUCache.results">
<a class="viewcode-back" href="../../api/soundit/#soundit.LRUCache.results">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span></div>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;The dictionary between keys and values</span>

<span class="sd">        Checking and modifying the cache manually isn&#39;t recommended.</span>

<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LRUCache.get">
<a class="viewcode-back" href="../../api/soundit/#soundit.LRUCache.get">[docs]</a>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value_func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the value for this key, calling value_func if needed</span>

<span class="sd">        Arguments:</span>
<span class="sd">            key: unique key for a value</span>
<span class="sd">            value_func: a zero-arg function returning a value for this key</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If the key ain&#39;t in the cache...</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="c1"># Get the value from calling the function</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value_func</span><span class="p">()</span>
            <span class="c1"># Update cache with the value</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_miss</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="c1"># Ensure the cache&#39;s size isn&#39;t over self.maxsize</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_size</span><span class="p">()</span>

        <span class="c1"># If the key is in the cache...</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get the cached value</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hit</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="c1"># Return the value</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="LRUCache.clear">
<a class="viewcode-back" href="../../api/soundit/#soundit.LRUCache.clear">[docs]</a>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clears the cache and the hits / misses counters&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">misses</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; maxsize=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; hits=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; misses=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">misses</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="s2">&quot;&gt;&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_miss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># Note down that we missed it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">misses</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Update cache with the value</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># Return the value</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_hit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="c1"># Note down that we hit it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hits</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Move key to the end of the dict (LRU cache)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="c1"># Return the value</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_ensure_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Cache is unbounded</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># Fast path for maxsize of 0 (clear everything)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="c1"># Get old keys in the cache (order is kept in a dict)</span>
        <span class="n">old_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span>
            <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span><span class="p">,</span>
        <span class="p">))</span>
        <span class="c1"># Remove old keys</span>
        <span class="k">for</span> <span class="n">old_key</span> <span class="ow">in</span> <span class="n">old_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_key</span><span class="p">)</span>
        <span class="c1"># Force the dict to resize (inserts cause resizing)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<span class="c1"># - LRU cache for iterators</span>

<div class="viewcode-block" id="LRUIterableCache">
<a class="viewcode-back" href="../../api/soundit/#soundit.LRUIterableCache">[docs]</a>
<span class="k">class</span> <span class="nc">LRUIterableCache</span><span class="p">(</span><span class="n">LRUCache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An LRU cache for iterables</span>

<span class="sd">    This class internally stores `itertools.tee` objects wrapped around the</span>
<span class="sd">    original values and returns a copy of the tees in the cache.</span>

<span class="sd">    We use tee objects for a few reasons:</span>

<span class="sd">    - They can be iterated at different speeds.</span>
<span class="sd">    - They are iterators (lazily evaluated).</span>
<span class="sd">    - They can be copied (major orz for this one).</span>
<span class="sd">    - They are fast (implemented in C).</span>

<span class="sd">    See `LRUCache` for more info on caching. See `itertools.tee` for more info on</span>
<span class="sd">    tee objects.</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="LRUIterableCache.get">
<a class="viewcode-back" href="../../api/soundit/#soundit.LRUIterableCache.get">[docs]</a>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">iterable_func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the iterator for this key, calling iterable_func if needed</span>

<span class="sd">        If a matching tee is cached, return a copy. If no tee is found, create</span>
<span class="sd">        a new one using the iterable_func and make a copy of it.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">has_numpy</span><span class="p">:</span>
            <span class="c1"># Defer cache get until we know if it&#39;s a sound or a numpy iterator</span>
            <span class="k">return</span> <span class="n">_NumpyConvertibleIterator</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">LRUIterableCache</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span>
                    <span class="k">lambda</span><span class="p">:</span> <span class="n">itertools</span><span class="o">.</span><span class="n">tee</span><span class="p">(</span><span class="n">iterable_func</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="p">),</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">LRUIterableCache</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span>
                    <span class="k">lambda</span><span class="p">:</span> <span class="n">itertools</span><span class="o">.</span><span class="n">tee</span><span class="p">(</span><span class="n">_to_numpy</span><span class="p">(</span><span class="n">iterable_func</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">def</span> <span class="nf">value_func</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">tee</span><span class="p">(</span><span class="n">iterable_func</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value_func</span><span class="p">))</span></div>
</div>


<div class="viewcode-block" id="lru_iter_cache">
<a class="viewcode-back" href="../../api/soundit/#soundit.lru_iter_cache">[docs]</a>
<span class="k">def</span> <span class="nf">lru_iter_cache</span><span class="p">(</span>
    <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">maxsize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
    <span class="n">cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LRUIterableCache</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator to wrap a function returning iterables</span>

<span class="sd">    Arguments:</span>
<span class="sd">        maxsize: the maximum size of the cache (None means unbounded)</span>
<span class="sd">        cache: the cache to use</span>

<span class="sd">    See `LRUIterableCache` for more info.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">lru_iter_cache</span><span class="p">,</span> <span class="n">maxsize</span><span class="o">=</span><span class="n">maxsize</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">)</span>

    <span class="c1"># Create the cache instance if necessary</span>
    <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">LRUIterableCache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">maxsize</span><span class="p">)</span>

    <span class="c1"># Wrap the original function</span>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_lru_iter_cache_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># The key must not be the same for different call args / kwargs.</span>
        <span class="c1"># Example: f(&quot;a&quot;, 1) vs f(a=1).</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">def</span> <span class="nf">iterable_func</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">iterable_func</span><span class="p">)</span>

    <span class="c1"># Add the cache to the function object for later introspection</span>
    <span class="n">_lru_iter_cache_wrapper</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>  <span class="c1"># type: ignore</span>
    <span class="n">_lru_iter_cache_wrapper</span><span class="o">.</span><span class="n">cache_clear</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">clear</span>  <span class="c1"># type: ignore</span>

    <span class="c1"># Return the wrapper function</span>
    <span class="k">return</span> <span class="n">_lru_iter_cache_wrapper</span></div>



<span class="c1"># - Experimental string pluck synthesis</span>

<span class="k">def</span> <span class="nf">_with_self_tee</span><span class="p">(</span><span class="n">genfunc</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="k">yield</span>
        <span class="k">yield</span>
        <span class="k">yield from</span> <span class="n">genfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">genfunc</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_exposed</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="n">_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">iterator</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">tee</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
        <span class="n">iterator</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">tail</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">head</span>
    <span class="k">return</span> <span class="n">_exposed</span>

<span class="nd">@_with_self_tee</span>
<span class="k">def</span> <span class="nf">_pluck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mi">440</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">square</span><span class="p">):</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="n">cut</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">freq</span><span class="p">,</span> <span class="n">func</span><span class="p">(</span><span class="n">freq</span><span class="p">))</span>
    <span class="n">sound</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
        <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">tee</span><span class="p">(</span><span class="n">sound</span><span class="p">)</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tail</span><span class="p">,</span> <span class="n">head</span><span class="p">):</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="mf">0.99</span>

<span class="c1"># - FFmpeg utilities</span>

<div class="viewcode-block" id="create_ffmpeg_process">
<a class="viewcode-back" href="../../api/soundit/#soundit.create_ffmpeg_process">[docs]</a>
<span class="k">def</span> <span class="nf">create_ffmpeg_process</span><span class="p">(</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;ffmpeg&quot;</span><span class="p">,</span>
    <span class="n">pipe_stdin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">pipe_stdout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">pipe_stderr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a process that run FFmpeg with the given arguments</span>

<span class="sd">    This assumes that ``ffmpeg.exe`` is on your PATH environment variable. If not,</span>
<span class="sd">    you can specify its location using the executable argument.</span>

<span class="sd">    For the ``pipe_*`` arguments, if it is True, `subprocess.PIPE` will be passed to</span>
<span class="sd">    `subprocess.Popen`&#39;s constructor. Otherwise, None will be passed.</span>

<span class="sd">    All other keyword arguments are passed directly to `subprocess.Popen`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;stdin&quot;</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span> <span class="k">if</span> <span class="n">pipe_stdin</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span> <span class="k">if</span> <span class="n">pipe_stdout</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span> <span class="k">if</span> <span class="n">pipe_stderr</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">subprocess_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">executable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">],</span> <span class="o">**</span><span class="n">subprocess_kwargs</span><span class="p">)</span></div>


<span class="k">if</span> <span class="n">TYPE_CHECKING</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">):</span>
    <span class="n">Popen</span><span class="p">:</span> <span class="n">TypeAlias</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span>
    <span class="s2">&quot;:meta private:&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">Popen</span><span class="p">:</span> <span class="n">TypeAlias</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span>

<div class="viewcode-block" id="chunked_ffmpeg_process">
<a class="viewcode-back" href="../../api/soundit/#soundit.chunked_ffmpeg_process">[docs]</a>
<span class="k">def</span> <span class="nf">chunked_ffmpeg_process</span><span class="p">(</span>
    <span class="n">process</span><span class="p">:</span> <span class="n">Popen</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">close</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns an iterator of chunks from the given process</span>

<span class="sd">    Arguments:</span>
<span class="sd">        process: the subprocess to stream stdout from</span>
<span class="sd">        close: whether to terminate the process when finished</span>

<span class="sd">    This function is hardcoded to take PCM 16-bit stereo audio, same as the</span>
<span class="sd">    chunked function. See that function for more info.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;process has no stdout&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">close</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">close</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">FRAME_SIZE_BYTES</span> <span class="o">=</span> <span class="mi">3840</span>  <span class="c1"># 20ms of 48kHz stereo 16-bit audio</span>
    <span class="n">check_return_code</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Stream stdout until EOF</span>
        <span class="k">yield from</span> <span class="n">equal_chunk_stream</span><span class="p">(</span>
            <span class="nb">iter</span><span class="p">(</span>
                <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                    <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">,</span>  <span class="c1"># speedup by removing a getattr</span>
                    <span class="n">FRAME_SIZE_BYTES</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">FRAME_SIZE_BYTES</span><span class="p">,</span>
            <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
        <span class="n">check_return_code</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">raise</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">close</span><span class="p">:</span>
            <span class="c1"># Terminating instead of closing pipes makes FFmpeg not cry &quot;Error</span>
            <span class="c1"># writing trailer of pipe:: Broken pipe&quot; on .mp3s</span>
            <span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
                <span class="n">process</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
                <span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">check_return_code</span> <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;process ended with a nonzero return code:&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="make_ffmpeg_section_args">
<a class="viewcode-back" href="../../api/soundit/#soundit.make_ffmpeg_section_args">[docs]</a>
<span class="k">def</span> <span class="nf">make_ffmpeg_section_args</span><span class="p">(</span>
    <span class="n">filename</span><span class="p">,</span>
    <span class="n">start</span><span class="p">,</span>
    <span class="n">length</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">before_options</span><span class="o">=</span><span class="p">(),</span>
    <span class="n">options</span><span class="o">=</span><span class="p">(),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a list of arguments to FFmpeg</span>

<span class="sd">    It will take the required amount of audio starting from the specified start</span>
<span class="sd">    time and convert them into PCM 16-bit stereo audio to be piped to stdout.</span>

<span class="sd">    The before_options argument will be passed after ``-ss`` and before ``-i``,</span>
<span class="sd">    and the options argument will be passed after ``-t`` and before ``pipe:1``.</span>

<span class="sd">    If length is None, the audio will play to the end of the file.</span>

<span class="sd">    The returned args are of this form::</span>

<span class="sd">        -ss {start}</span>
<span class="sd">        -t {length}</span>
<span class="sd">        {before_options}</span>
<span class="sd">        -i {filename}</span>
<span class="sd">        -f s16le</span>
<span class="sd">        -ar 48000</span>
<span class="sd">        -ac 2</span>
<span class="sd">        -loglevel warning</span>
<span class="sd">        -nostdin</span>
<span class="sd">        {options}</span>
<span class="sd">        pipe:1</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;start must be a float&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">before_options</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># Strings are naughty. Force user to split them beforehand</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;FFmpeg options should be lists, not strings&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="s2">&quot;-ss&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">start</span><span class="p">),</span>
        <span class="o">*</span><span class="p">((</span><span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span> <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">()),</span>
        <span class="o">*</span><span class="p">(</span><span class="n">before_options</span> <span class="ow">or</span> <span class="p">()),</span>
        <span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span>
        <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;s16le&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-ar&quot;</span><span class="p">,</span> <span class="s2">&quot;48000&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-ac&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-loglevel&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-nostdin&quot;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">(</span><span class="n">options</span> <span class="ow">or</span> <span class="p">()),</span>
        <span class="s2">&quot;pipe:1&quot;</span><span class="p">,</span>
    <span class="p">]</span></div>



<span class="c1"># - Byte stream utilities</span>

<div class="viewcode-block" id="loop_stream">
<a class="viewcode-back" href="../../api/soundit/#soundit.loop_stream">[docs]</a>
<span class="k">def</span> <span class="nf">loop_stream</span><span class="p">(</span>
    <span class="n">data_iterable</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">copy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">when_empty</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Consumes a stream of buffers and loops them forever</span>

<span class="sd">    Arguments:</span>
<span class="sd">        data_iterable: the iterable of buffers</span>
<span class="sd">        copy: whether or not to copy the buffers</span>
<span class="sd">        when_empty: what to do when data is empty (ignore or error)</span>

<span class="sd">    Returns:</span>
<span class="sd">        stream of buffers</span>

<span class="sd">    The buffers are reused upon looping. If the buffers are known to be unused</span>
<span class="sd">    after being yielded, you can set copy to False to save some time copying.</span>

<span class="sd">    When sum(len(b) for b in buffers) == 0, a RuntimeError will be raised.</span>
<span class="sd">    Otherwise, this function can end up in an infinite loop, or it can cause</span>
<span class="sd">    other functions to never yield (such as equal_chunk_stream). This behaviour</span>
<span class="sd">    is almost never useful, though if necessary, pass when_empty=&quot;ignore&quot; to</span>
<span class="sd">    suppress the error.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from itertools import islice</span>
<span class="sd">        &gt;&gt;&gt; parts = [b&quot;abc&quot;, b&quot;def&quot;, b&quot;ghi&quot;]</span>
<span class="sd">        &gt;&gt;&gt; looped = list(islice(loop_stream(parts), 9))</span>
<span class="sd">        &gt;&gt;&gt; looped[::3]</span>
<span class="sd">        [b&#39;abc&#39;, b&#39;abc&#39;, b&#39;abc&#39;]</span>
<span class="sd">        &gt;&gt;&gt; looped[1::3]</span>
<span class="sd">        [b&#39;def&#39;, b&#39;def&#39;, b&#39;def&#39;]</span>
<span class="sd">        &gt;&gt;&gt; looped[2::3]</span>
<span class="sd">        [b&#39;ghi&#39;, b&#39;ghi&#39;, b&#39;ghi&#39;]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">copy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">copy</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">when_empty</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">when_empty</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
    <span class="k">if</span> <span class="n">when_empty</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;when_empty must be ignore or error&quot;</span><span class="p">)</span>
    <span class="n">data_iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">data_iterable</span><span class="p">)</span>

    <span class="c1"># Deques have a guaranteed O(1) append; lists have worst case O(n)</span>
    <span class="n">data_buffers</span><span class="p">:</span> <span class="n">Deque</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">()</span>
    <span class="n">data_buffers_size</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">data_iterator</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
            <span class="n">data_iterator</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">data_iterator</span><span class="p">)</span>

        <span class="c1"># Read data until empty</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_iterator</span><span class="p">:</span>
            <span class="n">data_buffers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">data_buffers_size</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">data</span>

        <span class="c1"># Sanity check for empty buffer length</span>
        <span class="k">if</span> <span class="n">when_empty</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span> <span class="ow">and</span> <span class="n">data_buffers_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;empty data buffers&quot;</span><span class="p">)</span>

        <span class="c1"># Yield buffers forever</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">data_buffers</span></div>


<div class="viewcode-block" id="equal_chunk_stream">
<a class="viewcode-back" href="../../api/soundit/#soundit.equal_chunk_stream">[docs]</a>
<span class="k">def</span> <span class="nf">equal_chunk_stream</span><span class="p">(</span>
    <span class="n">data_iterable</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span>
    <span class="n">buffer_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">copy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Normalizes a stream of buffers into ones of length buffer_len</span>

<span class="sd">    Arguments:</span>
<span class="sd">        data_iterable: the iterable of buffers</span>
<span class="sd">        buffer_len: the size to normalize buffers to</span>
<span class="sd">        copy: return copies of the internal buffer. If ``False``, the yielded</span>
<span class="sd">            buffer may be reused to reduce object creation and collection.</span>

<span class="sd">    Returns:</span>
<span class="sd">        stream of buffers with len(buffer) == buffer_len except the last one</span>

<span class="sd">    The last buffer yielded is always smaller than buffer_len. Other code can</span>
<span class="sd">    fill it with zeros, drop it, or execute clean up code.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; list(equal_chunk_stream([b&quot;abcd&quot;, b&quot;efghi&quot;], 3))</span>
<span class="sd">        [b&#39;abc&#39;, b&#39;def&#39;, b&#39;ghi&#39;, b&#39;&#39;]</span>
<span class="sd">        &gt;&gt;&gt; list(equal_chunk_stream([b&quot;abcd&quot;, b&quot;efghijk&quot;], 3))</span>
<span class="sd">        [b&#39;abc&#39;, b&#39;def&#39;, b&#39;ghi&#39;, b&#39;jk&#39;]</span>
<span class="sd">        &gt;&gt;&gt; list(equal_chunk_stream([b&quot;a&quot;, b&quot;b&quot;, b&quot;c&quot;, b&quot;d&quot;], 3))</span>
<span class="sd">        [b&#39;abc&#39;, b&#39;d&#39;]</span>
<span class="sd">        &gt;&gt;&gt; list(equal_chunk_stream([], 3))</span>
<span class="sd">        [b&#39;&#39;]</span>
<span class="sd">        &gt;&gt;&gt; list(equal_chunk_stream([b&quot;&quot;, b&quot;&quot;], 3))</span>
<span class="sd">        [b&#39;&#39;]</span>
<span class="sd">        &gt;&gt;&gt; list(equal_chunk_stream([b&quot;&quot;, b&quot;&quot;, b&quot;a&quot;, b&quot;&quot;], 3))</span>
<span class="sd">        [b&#39;a&#39;]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">buffer_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;buffer length is not positive&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">copy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">copy</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">data_iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">data_iterable</span><span class="p">)</span>

    <span class="c1"># Easier to do map(bytes, ...) than to check it each yield (faster too?)</span>
    <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="n">equal_chunk_stream</span><span class="p">(</span><span class="n">data_iterable</span><span class="p">,</span> <span class="n">buffer_len</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">chunks</span><span class="p">))</span>

    <span class="c1"># Initialize buffer variables</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="nb">memoryview</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">buffer_len</span><span class="p">))</span>
    <span class="n">buffer_ptr</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">data_iterator</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_iterator</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">memoryview</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">)</span>

            <span class="c1"># This stores the size data is over by compared to the remaining</span>
            <span class="c1"># buffer size. If it&#39;s negative, it&#39;s the size it&#39;s under by.</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">-</span> <span class="n">buffer_len</span> <span class="o">+</span> <span class="n">buffer_ptr</span>

            <span class="k">if</span> <span class="n">end</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Faster to yield data directly (no copying to the buffer)</span>
                <span class="k">if</span> <span class="n">buffer_ptr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">data</span>
                    <span class="k">continue</span>

                <span class="n">buffer</span><span class="p">[</span><span class="n">buffer_ptr</span><span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
                <span class="k">yield</span> <span class="n">buffer</span>
                <span class="n">buffer_ptr</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">buffer</span><span class="p">[</span><span class="n">buffer_ptr</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                <span class="n">buffer_ptr</span> <span class="o">=</span> <span class="n">buffer_len</span> <span class="o">+</span> <span class="n">end</span>
                <span class="k">continue</span>

            <span class="n">buffer</span><span class="p">[</span><span class="n">buffer_ptr</span><span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span>
            <span class="k">yield</span> <span class="n">buffer</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="n">end</span><span class="p">:]</span>

            <span class="c1"># Yield buffer sized slices of data</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;=</span> <span class="n">buffer_len</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">buffer_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buffer_len</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">buffer_len</span><span class="p">]</span>

            <span class="n">buffer_ptr</span> <span class="o">=</span> <span class="n">end</span> <span class="o">%</span> <span class="n">buffer_len</span>
            <span class="k">if</span> <span class="n">buffer_ptr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">buffer</span><span class="p">[:</span><span class="n">buffer_ptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="n">buffer_ptr</span><span class="p">:]</span>

        <span class="c1"># Yield everything that we have left (could be b&quot;&quot;) so that other code</span>
        <span class="c1"># can simply check the length to know if the stream is ending.</span>
        <span class="k">yield</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">buffer_ptr</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">buffer</span><span class="p">[:</span><span class="n">buffer_ptr</span><span class="p">]</span></div>



<span class="c1"># - LibAV utilities</span>

<span class="k">def</span> <span class="nf">_chunked_libav_section</span><span class="p">(</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">start</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns an iterator of chunks from the specified file</span>

<span class="sd">    It will take the required amount of audio starting from the specified start</span>
<span class="sd">    time and convert them into PCM 16-bit stereo audio.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_av</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;av needed to decode file&quot;</span><span class="p">)</span>

    <span class="n">RATE</span> <span class="o">=</span> <span class="mi">48000</span>  <span class="c1"># 48kHz</span>
    <span class="n">FRAME</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># frame width = stereo * 16-bit</span>

    <span class="c1"># Close after usage to prevent memory leaks</span>
    <span class="k">with</span> <span class="n">av</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_container</span><span class="p">,</span> \
            <span class="n">av</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(),</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;s16le&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pcm_container</span><span class="p">:</span>

        <span class="c1"># Input audio stream to decode from</span>
        <span class="n">in_stream</span> <span class="o">=</span> <span class="n">in_container</span><span class="o">.</span><span class="n">streams</span><span class="o">.</span><span class="n">audio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">in_stream</span><span class="o">.</span><span class="n">thread_type</span> <span class="o">=</span> <span class="s2">&quot;AUTO&quot;</span>  <span class="c1"># Use more threads for decoding</span>

        <span class="c1"># Output PCM stream to encode into</span>
        <span class="n">pcm_stream</span> <span class="o">=</span> <span class="n">pcm_container</span><span class="o">.</span><span class="n">add_stream</span><span class="p">(</span><span class="s2">&quot;pcm_s16le&quot;</span><span class="p">,</span> <span class="n">RATE</span><span class="p">)</span>
        <span class="n">pcm_stream</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="s2">&quot;stereo&quot;</span>

        <span class="c1"># Decoding state</span>
        <span class="n">got_initial</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Flag to correctly set in_skip after seeking</span>
        <span class="n">in_skip</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">start</span> <span class="o">/</span> <span class="n">in_stream</span><span class="o">.</span><span class="n">time_base</span><span class="p">)</span>  <span class="c1"># Frames to skip</span>
        <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pcm_left</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">length</span> <span class="o">*</span> <span class="n">RATE</span><span class="p">)</span>  <span class="c1"># Frames to keep</span>

        <span class="c1"># Seek to a keyframe at or before in_skip frames</span>
        <span class="n">in_container</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">in_skip</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">in_stream</span><span class="p">)</span>

        <span class="c1"># Loop frames from the input</span>
        <span class="k">for</span> <span class="n">in_packet</span> <span class="ow">in</span> <span class="n">in_container</span><span class="o">.</span><span class="n">demux</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">in_frame</span> <span class="ow">in</span> <span class="n">in_stream</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">in_packet</span><span class="p">):</span>
                <span class="c1"># If this is the first frame, subtract current from in_skip</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">got_initial</span><span class="p">:</span>
                    <span class="n">in_skip</span> <span class="o">-=</span> <span class="n">in_frame</span><span class="o">.</span><span class="n">pts</span>
                    <span class="n">got_initial</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Skip the whole frame if we don&#39;t need it</span>
                <span class="k">if</span> <span class="n">in_skip</span> <span class="o">&gt;=</span> <span class="n">in_frame</span><span class="o">.</span><span class="n">samples</span><span class="p">:</span>
                    <span class="n">in_skip</span> <span class="o">-=</span> <span class="n">in_frame</span><span class="o">.</span><span class="n">samples</span>
                    <span class="k">continue</span>

                <span class="c1"># Encode into PCM</span>
                <span class="n">in_frame</span><span class="o">.</span><span class="n">pts</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Have pcm_stream join frames together</span>
                <span class="n">pcm_packet</span> <span class="o">=</span> <span class="nb">memoryview</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pcm_stream</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">in_frame</span><span class="p">)))</span>

                <span class="c1"># If there&#39;s still a part to skip, skip it</span>
                <span class="k">if</span> <span class="n">in_skip</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pcm_skip</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">in_skip</span> <span class="o">*</span> <span class="n">in_stream</span><span class="o">.</span><span class="n">time_base</span> <span class="o">*</span> <span class="n">RATE</span><span class="p">)</span>
                    <span class="n">pcm_packet</span> <span class="o">=</span> <span class="n">pcm_packet</span><span class="p">[</span><span class="n">pcm_skip</span><span class="o">*</span><span class="n">FRAME</span><span class="p">:]</span>
                    <span class="n">in_skip</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># If no length was specified, yield everything</span>
                <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">pcm_packet</span>
                    <span class="k">continue</span>

                <span class="c1"># If this is the last packet, cut the end, yield, and break</span>
                <span class="n">pcm_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pcm_packet</span><span class="p">)</span> <span class="o">//</span> <span class="n">FRAME</span>
                <span class="k">if</span> <span class="n">pcm_left</span> <span class="o">&lt;=</span> <span class="n">pcm_length</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pcm_left</span> <span class="o">&lt;</span> <span class="n">pcm_length</span><span class="p">:</span>
                        <span class="n">pcm_packet</span> <span class="o">=</span> <span class="n">pcm_packet</span><span class="p">[:</span><span class="n">pcm_left</span><span class="o">*</span><span class="n">FRAME</span><span class="p">]</span>
                    <span class="k">yield</span> <span class="n">pcm_packet</span>
                    <span class="k">return</span>

                <span class="c1"># Update frames left and yield</span>
                <span class="n">pcm_left</span> <span class="o">-=</span> <span class="n">pcm_length</span>
                <span class="k">yield</span> <span class="n">pcm_packet</span>

        <span class="c1"># Flush buffers and yield the last bits</span>
        <span class="n">pcm_packet</span> <span class="o">=</span> <span class="nb">memoryview</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pcm_stream</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="kc">None</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Yield everything</span>
            <span class="k">yield</span> <span class="n">pcm_packet</span>
            <span class="k">return</span>
        <span class="n">pcm_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pcm_packet</span><span class="p">)</span> <span class="o">//</span> <span class="n">FRAME</span>
        <span class="k">if</span> <span class="n">pcm_left</span> <span class="o">&lt;</span> <span class="n">pcm_length</span><span class="p">:</span>
            <span class="n">pcm_packet</span> <span class="o">=</span> <span class="n">pcm_packet</span><span class="p">[:</span><span class="n">pcm_left</span><span class="o">*</span><span class="n">FRAME</span><span class="p">]</span>
        <span class="k">yield</span> <span class="n">pcm_packet</span>


<span class="c1"># - Sound creation utilities</span>

<span class="nd">@_convertible</span>
<div class="viewcode-block" id="passed">
<a class="viewcode-back" href="../../api/soundit/#soundit.passed">[docs]</a>
<span class="k">def</span> <span class="nf">passed</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a sound lasting the specified time yielding the seconds passed</span>

<span class="sd">    This abstracts away the use of RATE to calculate the number of points.</span>

<span class="sd">    If seconds is None, the returned sound will be unbounded.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; x = list(passed(0.25))</span>
<span class="sd">        &gt;&gt;&gt; x[0] * RATE</span>
<span class="sd">        0.0</span>
<span class="sd">        &gt;&gt;&gt; x[1] * RATE</span>
<span class="sd">        1.0</span>
<span class="sd">        &gt;&gt;&gt; len(x) / RATE</span>
<span class="sd">        0.25</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">seconds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seconds</span> <span class="o">*</span> <span class="n">RATE</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">i</span> <span class="o">/</span> <span class="n">RATE</span></div>


<span class="nd">@passed</span><span class="o">.</span><span class="n">_as_numpy</span>
<span class="k">def</span> <span class="nf">_numpy_passed</span><span class="p">(</span><span class="n">seconds</span><span class="p">):</span>
    <span class="n">CHUNK_SIZE</span> <span class="o">=</span> <span class="n">RATE</span> <span class="o">//</span> <span class="mi">50</span>  <span class="c1"># We divide a second into 50 numpy arrays</span>
    <span class="k">if</span> <span class="n">seconds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CHUNK_SIZE</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">seconds</span> <span class="o">*</span> <span class="n">RATE</span><span class="p">),</span> <span class="n">CHUNK_SIZE</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="n">CHUNK_SIZE</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="n">i</span><span class="p">,</span>
            <span class="n">i</span> <span class="o">+</span> <span class="n">CHUNK_SIZE</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">RATE</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="n">CHUNK_SIZE</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="n">i</span><span class="p">,</span>
            <span class="n">i</span> <span class="o">+</span> <span class="n">CHUNK_SIZE</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">RATE</span><span class="p">)[:</span><span class="nb">int</span><span class="p">(</span><span class="n">seconds</span> <span class="o">*</span> <span class="n">RATE</span><span class="p">)</span> <span class="o">%</span> <span class="n">CHUNK_SIZE</span><span class="p">]</span>

<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">_closeiter</span><span class="p">(</span><span class="n">iterator</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">iterator</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="s2">&quot;close&quot;</span><span class="p">):</span>
            <span class="n">iterator</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># type: ignore[attr-defined]</span>

<span class="k">class</span> <span class="nc">_PreservedIterator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterator</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span> <span class="o">=</span> <span class="n">iterator</span>

    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">_preserveiter</span><span class="p">(</span><span class="n">iterator</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">):</span>
    <span class="k">yield</span> <span class="n">_PreservedIterator</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>


<span class="c1"># - Sound effects</span>

<span class="nd">@_convertible</span>
<div class="viewcode-block" id="fade">
<a class="viewcode-back" href="../../api/soundit/#soundit.fade">[docs]</a>
<span class="k">def</span> <span class="nf">fade</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">fadein</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">fadeout</span><span class="o">=</span><span class="mf">0.005</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fades in and out of the sound</span>

<span class="sd">    If the sound is less than fadein + fadeout seconds, the time between fading</span>
<span class="sd">    in and fading out is split proportionally.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
        <span class="n">fadein</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fadein</span> <span class="o">*</span> <span class="n">RATE</span><span class="p">)</span>
        <span class="n">fadeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fadeout</span> <span class="o">*</span> <span class="n">RATE</span><span class="p">)</span>

        <span class="c1"># First get fadein + fadeout samples</span>
        <span class="n">last</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">last</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">fadein</span> <span class="o">+</span> <span class="n">fadeout</span><span class="p">:</span>
                <span class="n">last</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">iterator</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">StopIteration</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># If we ended early, pretend the fade exists and use the smaller</span>
            <span class="c1"># volume from fadein or fadeout.</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">last</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">point</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">fadein</span> <span class="k">if</span> <span class="n">fadein</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">last</span><span class="p">)</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">fadeout</span> <span class="k">if</span> <span class="n">fadeout</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">value</span>
        <span class="c1"># Yield the fadein part</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fadein</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">last</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">fadein</span><span class="p">)</span>
        <span class="c1"># Remove the fadein</span>
        <span class="k">del</span> <span class="n">last</span><span class="p">[:</span><span class="n">fadein</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">last</span><span class="p">)</span> <span class="o">==</span> <span class="n">fadeout</span>
        <span class="c1"># If there&#39;s no fadeout, yield rest of the sound without changes.</span>
        <span class="k">if</span> <span class="n">fadeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">iterator</span><span class="p">)</span>
        <span class="c1"># Loop until the sound ends. We use the last list as a circular buffer with</span>
        <span class="c1"># the insert variable pointing to the next index to be overwritten.</span>
        <span class="n">insert</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Yield the oldest point and get the next point</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">last</span><span class="p">[</span><span class="n">insert</span><span class="p">]</span>
                <span class="n">last</span><span class="p">[</span><span class="n">insert</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">value</span>
                <span class="n">insert</span> <span class="o">=</span> <span class="p">(</span><span class="n">insert</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">fadeout</span>
        <span class="k">except</span> <span class="ne">StopIteration</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Yield the fadeout</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">insert</span> <span class="o">-</span> <span class="n">fadeout</span><span class="p">,</span> <span class="n">insert</span><span class="p">)):</span>
                <span class="k">yield</span> <span class="n">last</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="p">((</span><span class="n">fadeout</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">fadeout</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">value</span></div>


<span class="nd">@fade</span><span class="o">.</span><span class="n">_as_numpy</span>
<span class="k">def</span> <span class="nf">_numpy_fade</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">fadein</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">fadeout</span><span class="o">=</span><span class="mf">0.005</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
        <span class="n">fadein</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fadein</span> <span class="o">*</span> <span class="n">RATE</span><span class="p">)</span>
        <span class="n">fadeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fadeout</span> <span class="o">*</span> <span class="n">RATE</span><span class="p">)</span>

        <span class="n">initial</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">buffers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">array</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_to_numpy</span><span class="p">(</span><span class="n">passed</span><span class="p">(</span><span class="kc">None</span><span class="p">)),</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">iterator</span><span class="p">)):</span>
            <span class="c1"># First get fadein + fadeout samples</span>
            <span class="k">if</span> <span class="n">initial</span><span class="p">:</span>
                <span class="n">buffers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
                <span class="n">samples</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">samples</span> <span class="o">&lt;</span> <span class="n">fadein</span> <span class="o">+</span> <span class="n">fadeout</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">initial</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># Yield the fadein part</span>
                <span class="n">fadein_index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">array</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buffers</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">fadein</span><span class="p">:</span>
                        <span class="n">array</span> <span class="o">*=</span> <span class="p">(</span>
                            <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                                <span class="n">fadein_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="n">fadein_index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">),</span>
                            <span class="p">)</span> <span class="o">/</span> <span class="n">fadein</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">fadein_index</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fadein_index</span> <span class="o">&gt;=</span> <span class="n">fadein</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">yield</span> <span class="n">array</span>
                <span class="k">del</span> <span class="n">buffers</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
                <span class="n">samples</span> <span class="o">-=</span> <span class="n">fadein_index</span>
                <span class="n">samples</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
                <span class="n">array</span> <span class="o">=</span> <span class="n">buffers</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">samples</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
            <span class="c1"># Loop until the sound ends. We use the buffers list to hold sounds</span>
            <span class="c1"># until the fade out doesn&#39;t cover an array anymore.</span>
            <span class="n">buffers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
            <span class="n">samples</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">buffers</span> <span class="ow">and</span> <span class="n">samples</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">fadeout</span><span class="p">:</span>
                <span class="n">array</span> <span class="o">=</span> <span class="n">buffers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">samples</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">array</span>
        <span class="k">if</span> <span class="n">initial</span><span class="p">:</span>
            <span class="c1"># If we ended early, pretend the fade exists and use the smaller</span>
            <span class="c1"># volume from fadein or fadeout.</span>
            <span class="n">fadein_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">buffers</span><span class="p">:</span>
                <span class="n">samples</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
                <span class="n">fade</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">fadein</span><span class="p">:</span>
                    <span class="n">fade</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                        <span class="n">fade</span><span class="p">,</span>
                        <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                            <span class="n">fadein_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">fadein_index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">),</span>
                        <span class="p">)</span> <span class="o">/</span> <span class="n">fadein</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">fadeout</span><span class="p">:</span>
                    <span class="n">fade</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                        <span class="n">fade</span><span class="p">,</span>
                        <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                            <span class="n">samples</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">),</span>
                            <span class="n">samples</span><span class="p">,</span>
                            <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                        <span class="p">)</span> <span class="o">/</span> <span class="n">fadeout</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">array</span> <span class="o">*=</span> <span class="n">fade</span>
                <span class="n">fadein_index</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">array</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Yield the fadeout</span>
            <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">buffers</span><span class="p">:</span>
                <span class="n">samples</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fadeout</span><span class="p">:</span>
                    <span class="n">array</span> <span class="o">*=</span> <span class="p">(</span>
                        <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                            <span class="n">samples</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">),</span>
                            <span class="n">samples</span><span class="p">,</span>
                            <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                        <span class="p">)</span> <span class="o">/</span> <span class="n">fadeout</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">array</span>

<div class="viewcode-block" id="both">
<a class="viewcode-back" href="../../api/soundit/#soundit.both">[docs]</a>
<span class="k">def</span> <span class="nf">both</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Deprecated. sound.chunked accepts floats&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">num</span><span class="p">,</span> <span class="n">num</span></div>


<span class="nd">@_convertible</span>
<div class="viewcode-block" id="single">
<a class="viewcode-back" href="../../api/soundit/#soundit.single">[docs]</a>
<span class="k">def</span> <span class="nf">single</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge stereo sounds into mono&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span></div>


<span class="nd">@single</span><span class="o">.</span><span class="n">_as_numpy</span>
<span class="k">def</span> <span class="nf">_numpy_single</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="ow">in</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

<span class="nd">@_convertible</span>
<div class="viewcode-block" id="volume">
<a class="viewcode-back" href="../../api/soundit/#soundit.volume">[docs]</a>
<span class="k">def</span> <span class="nf">volume</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">sound</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Multiplies each point by the specified factor&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">sound</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">num</span> <span class="o">*</span> <span class="n">factor</span></div>


<span class="nd">@volume</span><span class="o">.</span><span class="n">_as_numpy</span>
<span class="k">def</span> <span class="nf">_numpy_volume</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">sound</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">array</span> <span class="o">*</span> <span class="n">factor</span>

<span class="nd">@_convertible</span>
<div class="viewcode-block" id="cut">
<a class="viewcode-back" href="../../api/soundit/#soundit.cut">[docs]</a>
<span class="k">def</span> <span class="nf">cut</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="n">sound</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ends the sound after the specified time&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">passed</span><span class="p">(</span><span class="n">seconds</span><span class="p">),</span> <span class="n">sound</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">point</span></div>


<span class="nd">@cut</span><span class="o">.</span><span class="n">_as_numpy</span>
<span class="k">def</span> <span class="nf">_numpy_cut</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="n">sound</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">array</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_to_numpy</span><span class="p">(</span><span class="n">passed</span><span class="p">(</span><span class="n">seconds</span><span class="p">)),</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">sound</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
            <span class="k">yield</span> <span class="n">array</span>

<span class="nd">@_convertible</span>
<div class="viewcode-block" id="pad">
<a class="viewcode-back" href="../../api/soundit/#soundit.pad">[docs]</a>
<span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="n">sound</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pads the sound with silence if shorter than the specified time&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
        <span class="n">padded</span> <span class="o">=</span> <span class="n">cut</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="n">silence</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">padded</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">point</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">sound</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">x</span>
                <span class="k">yield from</span> <span class="n">padded</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">point</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">sound</span></div>


<span class="nd">@pad</span><span class="o">.</span><span class="n">_as_numpy</span>
<span class="k">def</span> <span class="nf">_numpy_pad</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="n">sound</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
        <span class="n">sound</span> <span class="o">=</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">sound</span><span class="p">)</span>
        <span class="n">padded</span> <span class="o">=</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">cut</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="n">silence</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">padded</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">array</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">sound</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">x</span>
                <span class="k">yield from</span> <span class="n">padded</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                    <span class="n">x</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)]</span> <span class="o">=</span> <span class="n">array</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">x</span>
                <span class="k">yield</span> <span class="n">array</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">sound</span>

<span class="nd">@_convertible</span>
<div class="viewcode-block" id="_cut_cross">
<a class="viewcode-back" href="../../api/soundit/#soundit._cut_cross">[docs]</a>
<span class="k">def</span> <span class="nf">_cut_cross</span><span class="p">(</span><span class="n">seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sound</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;End sound at the first sign flip after the specified time</span>

<span class="sd">    :meta public:</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
        <span class="n">point</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">passed</span><span class="p">(</span><span class="n">seconds</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">point</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">sound</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">point</span>
        <span class="n">last_point</span> <span class="o">=</span> <span class="n">point</span>
        <span class="k">if</span> <span class="n">last_point</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">sound</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">last_point</span><span class="o">*</span><span class="n">point</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">yield</span> <span class="n">point</span></div>


<span class="nd">@_cut_cross</span><span class="o">.</span><span class="n">_as_numpy</span>
<span class="k">def</span> <span class="nf">_numpy__cut_cross</span><span class="p">(</span><span class="n">seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sound</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
        <span class="n">sound</span> <span class="o">=</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">sound</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">last_point</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">passed</span><span class="p">(</span><span class="n">seconds</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">array</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">sound</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">array</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
                        <span class="n">last_point</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">array</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">last_point</span><span class="o">*</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">yield from</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">passed</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                    <span class="k">break</span>
                <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">array</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span> <span class="o">&lt;=</span> <span class="mi">0</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">yield</span> <span class="n">array</span><span class="p">[:</span><span class="n">index</span><span class="o">+</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">break</span>
            <span class="k">yield</span> <span class="n">array</span>
            <span class="n">last_point</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">array</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">sound</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">break</span>

<div class="viewcode-block" id="exact">
<a class="viewcode-back" href="../../api/soundit/#soundit.exact">[docs]</a>
<span class="k">def</span> <span class="nf">exact</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="n">sound</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cuts or pads the sound to make it exactly the specified time&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">cut</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="n">pad</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="n">sound</span><span class="p">))</span></div>


<span class="nd">@_convertible</span>
<div class="viewcode-block" id="delay">
<a class="viewcode-back" href="../../api/soundit/#soundit.delay">[docs]</a>
<span class="k">def</span> <span class="nf">delay</span><span class="p">(</span><span class="n">seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sound</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add silence before the sound&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="n">cut</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="n">silence</span><span class="p">())</span>
        <span class="k">yield from</span> <span class="n">sound</span></div>


<span class="nd">@delay</span><span class="o">.</span><span class="n">_as_numpy</span>
<span class="k">def</span> <span class="nf">_numpy_delay</span><span class="p">(</span><span class="n">seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sound</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
        <span class="n">last</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">cut</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="n">silence</span><span class="p">())):</span>
            <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">last</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">array</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">sound</span><span class="p">))</span>

        <span class="n">buffer</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">_to_numpy</span><span class="p">(</span><span class="n">silence</span><span class="p">()))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="n">buffer</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span> <span class="o">=</span> <span class="n">array</span><span class="p">[:</span><span class="o">-</span><span class="n">index</span><span class="p">]</span>
            <span class="k">yield</span> <span class="n">buffer</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">buffer</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="n">index</span><span class="p">:]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="n">index</span><span class="p">:</span>
            <span class="n">buffer</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span> <span class="o">=</span> <span class="n">array</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="n">index</span><span class="p">]</span>
            <span class="k">yield</span> <span class="n">buffer</span>
            <span class="k">yield</span> <span class="n">array</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="n">index</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">buffer</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="n">index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)]</span> <span class="o">=</span> <span class="n">array</span>
            <span class="k">yield</span> <span class="n">buffer</span><span class="p">[:</span><span class="n">index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)]</span>

<span class="nd">@_convertible</span>
<div class="viewcode-block" id="_resample_linear">
<a class="viewcode-back" href="../../api/soundit/#soundit._resample_linear">[docs]</a>
<span class="k">def</span> <span class="nf">_resample_linear</span><span class="p">(</span><span class="n">factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sound</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resample the sound using linear interpolation</span>

<span class="sd">    The returned sound will be shorter/longer by 1 over the specified factor.</span>
<span class="sd">    Resampling a sound created by ``cut(1, sine(440))`` would give a sound</span>
<span class="sd">    similar to one created by ``cut(1/factor, 440*factor)``.</span>

<span class="sd">    :meta public:</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">passed</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">next_sample</span> <span class="o">=</span> <span class="n">factor</span><span class="o">*</span><span class="nb">next</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span>
    <span class="n">last_point</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">last_x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">passed</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">sound</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">next_sample</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">:</span>
            <span class="c1"># This is closest to how NumPy calculates linear interpolation</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">point</span> <span class="o">-</span> <span class="n">last_point</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">last_x</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">last_point</span> <span class="o">+</span> <span class="n">slope</span><span class="o">*</span><span class="p">(</span><span class="n">next_sample</span> <span class="o">-</span> <span class="n">last_x</span><span class="p">)</span>
            <span class="n">next_sample</span> <span class="o">=</span> <span class="n">factor</span><span class="o">*</span><span class="nb">next</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span>
        <span class="n">last_point</span> <span class="o">=</span> <span class="n">point</span>
        <span class="n">last_x</span> <span class="o">=</span> <span class="n">x</span></div>


<span class="nd">@_resample_linear</span><span class="o">.</span><span class="n">_as_numpy</span>
<span class="k">def</span> <span class="nf">_numpy__resample_linear</span><span class="p">(</span><span class="n">factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sound</span><span class="p">):</span>
    <span class="c1"># Note that the NumPy version is slightly off from the sound version</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">passed</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="n">next_sample</span> <span class="o">=</span> <span class="n">factor</span><span class="o">*</span><span class="nb">next</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">_to_numpy</span><span class="p">(</span><span class="n">silence</span><span class="p">()))</span>
    <span class="n">last_array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span>
    <span class="n">last_x</span> <span class="o">=</span> <span class="n">last_array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">last_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">array</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_to_numpy</span><span class="p">(</span><span class="n">passed</span><span class="p">(</span><span class="kc">None</span><span class="p">)),</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">sound</span><span class="p">)):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
        <span class="n">last_x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span>
        <span class="n">last_array</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">next_sample</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">last_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">next_sample</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">last_x</span><span class="p">[</span><span class="n">size</span><span class="p">],</span> <span class="s2">&quot;right&quot;</span><span class="p">)</span>
            <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                <span class="n">next_sample</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">],</span>
                <span class="n">last_x</span><span class="p">[:</span><span class="mi">1</span><span class="o">+</span><span class="n">size</span><span class="p">],</span>
                <span class="n">last_array</span><span class="p">[:</span><span class="mi">1</span><span class="o">+</span><span class="n">size</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">yield</span> <span class="n">buffer</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">next_sample</span> <span class="o">=</span> <span class="n">factor</span><span class="o">*</span><span class="nb">next</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">size</span><span class="p">:</span>
            <span class="n">last_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">last_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">yield</span> <span class="n">buffer</span><span class="p">[:</span><span class="n">j</span><span class="p">]</span>


<span class="c1"># - Utility for audio sources</span>

<div class="viewcode-block" id="play_discord_source">
<a class="viewcode-back" href="../../api/soundit/#soundit.play_discord_source">[docs]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">play_discord_source</span><span class="p">(</span><span class="n">voice_client</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plays and waits until the source finishes playing&quot;&quot;&quot;</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">after</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">future</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
    <span class="n">voice_client</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">after</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">future</span>
    <span class="k">return</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span></div>


<span class="k">if</span> <span class="n">has_discord</span><span class="p">:</span>
    <span class="c1"># Make our class a subclass of discord.py AudioSource if possible</span>
<div class="viewcode-block" id="DiscordIteratorSource">
<a class="viewcode-back" href="../../api/soundit/#soundit.DiscordIteratorSource">[docs]</a>
    <span class="k">class</span> <span class="nc">DiscordIteratorSource</span><span class="p">(</span><span class="n">discord</span><span class="o">.</span><span class="n">AudioSource</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal subclass of discord.py&#39;s AudioSource for iterators</span>

<span class="sd">        See wrap_discord_source for more info.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterator</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">is_opus</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span> <span class="o">=</span> <span class="n">iterator</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_opus</span> <span class="o">=</span> <span class="n">is_opus</span>

<div class="viewcode-block" id="DiscordIteratorSource.is_opus">
<a class="viewcode-back" href="../../api/soundit/#soundit.DiscordIteratorSource.is_opus">[docs]</a>
        <span class="k">def</span> <span class="nf">is_opus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_opus</span></div>


<div class="viewcode-block" id="DiscordIteratorSource.cleanup">
<a class="viewcode-back" href="../../api/soundit/#soundit.DiscordIteratorSource.cleanup">[docs]</a>
        <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">close</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span><span class="o">.</span><span class="n">close</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="DiscordIteratorSource.read">
<a class="viewcode-back" href="../../api/soundit/#soundit.DiscordIteratorSource.read">[docs]</a>
        <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span></div>
</div>


<div class="viewcode-block" id="wrap_discord_source">
<a class="viewcode-back" href="../../api/soundit/#soundit.wrap_discord_source">[docs]</a>
<span class="k">def</span> <span class="nf">wrap_discord_source</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">is_opus</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wraps an iterator of bytes into an audio source</span>

<span class="sd">    If is_opus is False (the default), the iterator must yield 20ms of signed</span>
<span class="sd">    16-bit little endian stereo 48kHz audio each iteration. If is_opus is True,</span>
<span class="sd">    the iterator should yield 20ms of Opus encoded audio each iteration.</span>

<span class="sd">    Example:</span>
<span class="sd">      ::</span>

<span class="sd">        # source implements discord.AudioSource</span>
<span class="sd">        source = wrap_discord_source(chunked(cut(1, sine(440))))</span>
<span class="sd">        ctx.voice_client.play(source, after=lambda _: print(&quot;finished&quot;))</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_discord</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;discord.py needed to make discord.AudioSources&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">DiscordIteratorSource</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">is_opus</span><span class="o">=</span><span class="n">is_opus</span><span class="p">)</span></div>


<div class="viewcode-block" id="chunked">
<a class="viewcode-back" href="../../api/soundit/#soundit.chunked">[docs]</a>
<span class="k">def</span> <span class="nf">chunked</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a stream of floats or two-tuples of floats in [-1, 1) to bytes</span>

<span class="sd">    This is hardcoded to return 20ms chunks of signed 16-bit little endian</span>
<span class="sd">    stereo 48kHz audio.</span>

<span class="sd">    If the sound yield float instead of two-tuples, it will have both sides</span>
<span class="sd">    play the same point.</span>

<span class="sd">    If the sound doesn&#39;t complete on a chunk border, null bytes will be added</span>
<span class="sd">    until it reaches the required length, which should be 3840 bytes.</span>

<span class="sd">    Note that floats not in the range [-1, 1) will be silently truncated to</span>
<span class="sd">    fall inside the range. For example, 1.5 will be processed as 1 and -1.5</span>
<span class="sd">    will be processed as -1.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">volume</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 16-bit signed</span>
    <span class="n">high</span><span class="p">,</span> <span class="n">low</span> <span class="o">=</span> <span class="n">volume</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">volume</span>  <span class="c1"># allowed range</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="mi">48000</span>  <span class="c1"># 48kHz</span>
    <span class="n">chunks_per_second</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">//</span><span class="mi">20</span>  <span class="c1"># 20ms</span>
    <span class="n">points_per_chunk</span> <span class="o">=</span> <span class="n">rate</span><span class="o">//</span><span class="n">chunks_per_second</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">points_per_chunk</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># 16-bit stereo</span>
    <span class="n">int_to_bytes</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">to_bytes</span>  <span class="c1"># speedup by removing a getattr</span>
    <span class="n">current</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
    <span class="c1"># Convert to numpy iterator if possible - the performance gain is HUGE. If</span>
    <span class="c1"># for some reason you require it to use floats (testing maybe), wrap the</span>
    <span class="c1"># argument with _ensure_sound.</span>
    <span class="k">if</span> <span class="n">has_numpy</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="s2">&quot;_as_numpy_iterator&quot;</span><span class="p">):</span>
        <span class="n">sound</span> <span class="o">=</span> <span class="n">sound</span><span class="o">.</span><span class="n">_as_numpy_iterator</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">sound</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">point</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">right</span> <span class="o">=</span> <span class="n">point</span>
        <span class="k">if</span> <span class="n">has_numpy</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="ow">is</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">left</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="n">right</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">volume</span> <span class="o">*</span> <span class="n">left</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">volume</span> <span class="o">*</span> <span class="n">right</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span>
            <span class="n">current</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;&lt;h&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">:</span>
                <span class="k">yield</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">current</span><span class="p">[:</span><span class="n">size</span><span class="p">])</span>
                <span class="k">del</span> <span class="n">current</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span>
            <span class="k">continue</span>
        <span class="n">left</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">volume</span> <span class="o">*</span> <span class="n">left</span><span class="p">)))</span>
        <span class="n">right</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">volume</span> <span class="o">*</span> <span class="n">right</span><span class="p">)))</span>
        <span class="n">current</span> <span class="o">+=</span> <span class="n">int_to_bytes</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;little&quot;</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">current</span> <span class="o">+=</span> <span class="n">int_to_bytes</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;little&quot;</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">:</span>
            <span class="k">yield</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
            <span class="n">current</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">current</span><span class="p">:</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00\x00\x00\x00</span><span class="s2">&quot;</span>
        <span class="k">yield</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">current</span><span class="p">)</span></div>


<div class="viewcode-block" id="unwrap_discord_source">
<a class="viewcode-back" href="../../api/soundit/#soundit.unwrap_discord_source">[docs]</a>
<span class="k">def</span> <span class="nf">unwrap_discord_source</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts an audio source into a stream of bytes</span>

<span class="sd">    This basically does the opposite of wrap_discord_source. See that</span>
<span class="sd">    function&#39;s documentation for more info.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">yield</span> <span class="n">chunk</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cleanup</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">cleanup</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cleanup</span><span class="p">()</span></div>


<span class="nd">@_convertible</span>
<div class="viewcode-block" id="unchunked">
<a class="viewcode-back" href="../../api/soundit/#soundit.unchunked">[docs]</a>
<span class="k">def</span> <span class="nf">unchunked</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a stream of bytes to two-tuples of floats in [-1, 1)</span>

<span class="sd">    This basically does the opposite of chunked. See that function&#39;s</span>
<span class="sd">    documentation for more info.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">volume</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 16-bit signed</span>
    <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="nb">memoryview</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">)</span>
            <span class="c1"># Not sure how to use extra bytes so they&#39;re ignored for now</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">iter_unpack</span><span class="p">(</span><span class="s2">&quot;&lt;2h&quot;</span><span class="p">,</span> <span class="n">chunk</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">left</span><span class="o">/</span><span class="n">volume</span><span class="p">,</span> <span class="n">right</span><span class="o">/</span><span class="n">volume</span></div>


<span class="nd">@unchunked</span><span class="o">.</span><span class="n">_as_numpy</span>
<span class="k">def</span> <span class="nf">_numpy_unchunked</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
    <span class="n">volume</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 16-bit signed</span>
    <span class="k">with</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">_to_numpy</span><span class="p">(</span><span class="n">silence</span><span class="p">()))),</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="nb">memoryview</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">)</span>
            <span class="c1"># Not sure how to use extra bytes so they&#39;re ignored for now</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">]</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;&lt;2h&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
            <span class="n">array</span> <span class="o">/=</span> <span class="n">volume</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">):</span>
                <span class="k">yield</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span> <span class="o">-</span> <span class="n">index</span>
                    <span class="n">buffer</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="n">index</span> <span class="o">+</span> <span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span>
                    <span class="n">index</span> <span class="o">+=</span> <span class="n">size</span>
                    <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">):</span>
                        <span class="k">break</span>
                    <span class="k">yield</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">size</span><span class="p">:]</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">yield</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">array</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

<span class="c1"># - Utility for note names and the like</span>

<div class="viewcode-block" id="make_frequencies_dict">
<a class="viewcode-back" href="../../api/soundit/#soundit.make_frequencies_dict">[docs]</a>
<span class="k">def</span> <span class="nf">make_frequencies_dict</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">A4_FREQUENCY</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Makes a dictionary containing frequencies for each note</span>

<span class="sd">    - a4 is the frequency for the A above middle C</span>
<span class="sd">    - offset is the number of semitones to offset each note by</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">frequencies</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="mi">12</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="n">offset</span>
            <span class="n">frequency</span> <span class="o">=</span> <span class="n">a4</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="p">((</span><span class="n">k</span> <span class="o">-</span> <span class="n">A4_INDEX</span><span class="p">)</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">frequencies</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">frequency</span>
    <span class="k">return</span> <span class="n">frequencies</span></div>


<div class="viewcode-block" id="make_indices_dict">
<a class="viewcode-back" href="../../api/soundit/#soundit.make_indices_dict">[docs]</a>
<span class="k">def</span> <span class="nf">make_indices_dict</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="n">NOTE_NAMES</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="mi">57</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Makes a dictionary containing note indices of common note names</span>

<span class="sd">    - a4 is the note index for the A above middle C</span>
<span class="sd">    - names is a list of note names</span>
<span class="sd">    - offset is the number of semitones to offset each note by</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">note</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">a4</span> <span class="o">-</span> <span class="n">A4_INDEX</span><span class="p">)</span>
            <span class="n">indices</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">note</span><span class="si">}{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">indices</span><span class="p">[</span><span class="n">note</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
    <span class="k">return</span> <span class="n">indices</span></div>



<span class="c1"># - Utilities for converting music to notes to sounds</span>

<div class="viewcode-block" id="music_to_notes">
<a class="viewcode-back" href="../../api/soundit/#soundit.music_to_notes">[docs]</a>
<span class="k">def</span> <span class="nf">music_to_notes</span><span class="p">(</span><span class="n">music</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">line_length</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts music into notes (two tuples of note name and length)</span>

<span class="sd">    This function returns a list of two-tuples of a string/None and a float.</span>
<span class="sd">    The first item is the note name (or a break if it is a None). The second</span>
<span class="sd">    item is its length.</span>

<span class="sd">    Note that there is a break between notes by default.</span>

<span class="sd">    A music string is first divided into lines with one line being the</span>
<span class="sd">    specified length, defaulting to 1. Each line is then split by whitespace</span>
<span class="sd">    into parts with the length divided evenly between them. Each part is then</span>
<span class="sd">    split by commas &quot;,&quot; into notes with the length again divided evenly between</span>
<span class="sd">    them.</span>

<span class="sd">    Empty lines or lines starting with a hash &quot;#&quot; are skipped.</span>

<span class="sd">    Note names can be almost anything. A note name of a dash &quot;-&quot; continues the</span>
<span class="sd">    previous note without a break between them. A suffix of a tilde &quot;~&quot; removes</span>
<span class="sd">    the break after the note, whereas an exclamation point &quot;!&quot; adds one.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Process lines</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">music</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="c1"># Skip empty lines and comments</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># Split into notes</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
            <span class="n">part_length</span> <span class="o">=</span> <span class="n">line_length</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
            <span class="n">notes</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">notes</span><span class="p">:</span>
                <span class="n">note_length</span> <span class="o">=</span> <span class="n">part_length</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span>

                <span class="c1"># Get flags and add to notes list</span>
                <span class="n">flags</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">note</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">):</span>
                    <span class="n">note</span> <span class="o">=</span> <span class="n">note</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">flags</span> <span class="o">+=</span> <span class="s2">&quot;~&quot;</span>
                <span class="k">elif</span> <span class="n">note</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">):</span>
                    <span class="n">note</span> <span class="o">=</span> <span class="n">note</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">flags</span> <span class="o">+=</span> <span class="s2">&quot;!&quot;</span>
                <span class="n">processed</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">note</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">note_length</span><span class="p">))</span>

    <span class="c1"># Generate notes</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">last_note</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">note</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">note_length</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">processed</span><span class="p">):</span>
        <span class="n">has_silence</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Check flags for silence</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span> <span class="ow">and</span> <span class="n">processed</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
            <span class="n">has_silence</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;~&quot;</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
            <span class="n">has_silence</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;!&quot;</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
            <span class="n">has_silence</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Get last note if current is a &quot;-&quot;</span>
        <span class="k">if</span> <span class="n">note</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
            <span class="n">note</span> <span class="o">=</span> <span class="n">last_note</span>

        <span class="c1"># Get length of silence</span>
        <span class="n">silent_length</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">has_silence</span><span class="p">:</span>
            <span class="n">silent_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">note_length</span><span class="p">)</span>
            <span class="n">note_length</span> <span class="o">-=</span> <span class="n">silent_length</span>
        <span class="k">if</span> <span class="n">note</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
            <span class="n">silent_length</span> <span class="o">+=</span> <span class="n">note_length</span>
            <span class="n">note_length</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Get / update note lengths</span>
        <span class="k">if</span> <span class="n">note_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">notes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">note</span><span class="p">:</span>
                <span class="n">notes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">note</span><span class="p">,</span> <span class="n">notes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">note_length</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">note</span><span class="p">,</span> <span class="n">note_length</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">silent_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="n">silent_length</span><span class="p">))</span>

        <span class="n">last_note</span> <span class="o">=</span> <span class="n">note</span>
    <span class="k">return</span> <span class="n">notes</span></div>


<div class="viewcode-block" id="split_music">
<a class="viewcode-back" href="../../api/soundit/#soundit.split_music">[docs]</a>
<span class="k">def</span> <span class="nf">split_music</span><span class="p">(</span><span class="n">music</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Splits music into individual sequences</span>

<span class="sd">    Lines starting with a slash &quot;/&quot; will be added to a new sequence. All other</span>
<span class="sd">    lines (including blanks and comments) will be part of the main sequence.</span>

<span class="sd">        &gt;&gt;&gt; assert split_music(&quot;1\n1&quot;) == [&quot;1\n1&quot;]</span>
<span class="sd">        &gt;&gt;&gt; assert split_music(&quot;1\n/2\n1&quot;) == [&quot;1\n1&quot;, &quot;2&quot;]</span>
<span class="sd">        &gt;&gt;&gt; assert split_music(&quot;1\n/2\n/3\n1\n/2&quot;) == [&quot;1\n1&quot;, &quot;2\n2&quot;, &quot;3&quot;]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sequences</span> <span class="o">=</span> <span class="p">[[]]</span>
    <span class="n">sequence_number</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">music</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="n">sequence_number</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sequence_number</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">sequence_number</span><span class="p">:</span>
            <span class="n">sequences</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">sequences</span><span class="p">[</span><span class="n">sequence_number</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sequences</span><span class="p">):</span>
        <span class="n">sequences</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sequences</span></div>


<span class="nd">@_convertible</span>
<div class="viewcode-block" id="notes_to_sine">
<a class="viewcode-back" href="../../api/soundit/#soundit.notes_to_sine">[docs]</a>
<span class="k">def</span> <span class="nf">notes_to_sine</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">line_length</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts notes into sine waves</span>

<span class="sd">    - notes is an iterator of two-tuples of note names/None and lengths</span>
<span class="sd">    - frequencies is a dict to look up the frequency for each note name</span>
<span class="sd">    - line_length is how much to scale the note by</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">note</span><span class="p">,</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">notes</span><span class="p">:</span>
        <span class="n">length</span> <span class="o">*=</span> <span class="n">line_length</span>
        <span class="k">if</span> <span class="n">note</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">cut</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">sine</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">frequencies</span><span class="p">[</span><span class="n">note</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">cut</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">silence</span><span class="p">())</span></div>


<span class="nd">@notes_to_sine</span><span class="o">.</span><span class="n">_as_numpy</span>
<span class="k">def</span> <span class="nf">_numpy_notes_to_sine</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">line_length</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">_to_numpy</span><span class="p">(</span><span class="n">silence</span><span class="p">()))</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">note</span><span class="p">,</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">notes</span><span class="p">:</span>
        <span class="n">length</span> <span class="o">*=</span> <span class="n">line_length</span>
        <span class="k">if</span> <span class="n">note</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sound</span> <span class="o">=</span> <span class="n">cut</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">sine</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">frequencies</span><span class="p">[</span><span class="n">note</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sound</span> <span class="o">=</span> <span class="n">cut</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">silence</span><span class="p">())</span>
        <span class="n">sound</span> <span class="o">=</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">sound</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">sound</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span> <span class="o">-</span> <span class="n">index</span>
            <span class="n">buffer</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="n">index</span> <span class="o">+</span> <span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="n">size</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">buffer</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">buffer</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">-</span> <span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">size</span><span class="p">:]</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">-</span> <span class="n">size</span>
    <span class="k">yield</span> <span class="n">buffer</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span>

<span class="nd">@_convertible</span>
<div class="viewcode-block" id="_notes_to_sound">
<a class="viewcode-back" href="../../api/soundit/#soundit._notes_to_sound">[docs]</a>
<span class="k">def</span> <span class="nf">_notes_to_sound</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts notes to a sound using the provided func</span>

<span class="sd">    The provided func is called with the note to get its sound. When there are</span>
<span class="sd">    no more notes to add nor sounds to play, this stops.</span>

<span class="sd">    :meta public:</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span>
    <span class="n">note</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Play until there are no more notes nor sounds</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">_IteratorPool</span><span class="p">())</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">passed</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="c1"># Add notes that should start by now</span>
            <span class="k">while</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">note</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">iterable</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">note</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
                <span class="n">start</span> <span class="o">+=</span> <span class="n">length</span>
                <span class="n">note</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mf">9e999</span><span class="p">))</span>  <span class="c1"># 9e999 == inf</span>
            <span class="c1"># Check for end of music</span>
            <span class="n">nums</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mf">9e999</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pool</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="c1"># Add component sounds up and yield it</span>
            <span class="k">yield</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span></div>

<span class="n">_layer</span> <span class="o">=</span> <span class="n">_notes_to_sound</span>  <span class="c1">#: :meta private:  # Old name</span>

<span class="nd">@_notes_to_sound</span><span class="o">.</span><span class="n">_as_numpy</span>
<span class="k">def</span> <span class="nf">_numpy__notes_to_sound</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span>
    <span class="n">note</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Play until there are no more notes nor sounds</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">_IteratorPool</span><span class="p">())</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">passed</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
            <span class="c1"># Add notes that should start by now</span>
            <span class="k">while</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">note</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">iterable</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">note</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">iterable</span> <span class="o">=</span> <span class="n">delay</span><span class="p">(</span><span class="n">start</span> <span class="o">-</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">iterable</span><span class="p">)</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">_to_numpy</span><span class="p">(</span><span class="n">iterable</span><span class="p">))</span>
                <span class="n">start</span> <span class="o">+=</span> <span class="n">length</span>
                <span class="n">note</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mf">9e999</span><span class="p">))</span>  <span class="c1"># 9e999 == inf</span>
            <span class="c1"># Check for end of music</span>
            <span class="n">nums</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">sound_lengths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">nums</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mf">9e999</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">sound_lengths</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
                <span class="n">array</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">sound_length</span><span class="p">,</span> <span class="n">sound</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sound_lengths</span><span class="p">,</span> <span class="n">nums</span><span class="p">):</span>
                    <span class="n">array</span><span class="p">[:</span><span class="n">sound_length</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sound</span>
                <span class="k">yield</span> <span class="n">array</span><span class="p">[:</span><span class="nb">max</span><span class="p">(</span><span class="n">sound_lengths</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>
                <span class="k">return</span>
            <span class="c1"># Add component sounds up and yield it</span>
            <span class="n">array</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sound_length</span><span class="p">,</span> <span class="n">sound</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sound_lengths</span><span class="p">,</span> <span class="n">nums</span><span class="p">):</span>
                <span class="n">array</span><span class="p">[:</span><span class="n">sound_length</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sound</span>
            <span class="k">yield</span> <span class="n">array</span>


<span class="c1"># - Experimental class for using multiple iterators in lockstep</span>

<span class="k">class</span> <span class="nc">_IteratorPool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pool of iterators to be iterated in lockstep</span>

<span class="sd">    This is similar to the built-in function zip but with some notable</span>
<span class="sd">    differences. Firstly, this class never stops iterating. It will return an</span>
<span class="sd">    empty list when there are no iterators. Secondly, having iterators of</span>
<span class="sd">    different lengths simply means the length of values will shrink as you go.</span>
<span class="sd">    Thirdly, you can add more iterators during iteration.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; pool = _IteratorPool()</span>
<span class="sd">        &gt;&gt;&gt; pool.add(&quot;aa&quot;)</span>
<span class="sd">        &gt;&gt;&gt; pool.add(&quot;bbbbb&quot;)</span>
<span class="sd">        &gt;&gt;&gt; pool.step()</span>
<span class="sd">        [&#39;a&#39;, &#39;b&#39;]</span>
<span class="sd">        &gt;&gt;&gt; pool.step()</span>
<span class="sd">        [&#39;a&#39;, &#39;b&#39;]</span>
<span class="sd">        &gt;&gt;&gt; pool.step()</span>
<span class="sd">        [&#39;b&#39;]</span>
<span class="sd">        &gt;&gt;&gt; pool.add(&quot;c&quot;)</span>
<span class="sd">        &gt;&gt;&gt; pool.step()</span>
<span class="sd">        [&#39;b&#39;, &#39;c&#39;]</span>
<span class="sd">        &gt;&gt;&gt; pool.step()</span>
<span class="sd">        [&#39;b&#39;]</span>
<span class="sd">        &gt;&gt;&gt; pool.step()</span>
<span class="sd">        []</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates an iterator pool&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterators</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_key</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterators</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">closed</span> <span class="o">=</span> <span class="s2">&quot; closed&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> len=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}{</span><span class="n">closed</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a list of values from all iterators in the pool&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of values from the iterators</span>
        <span class="n">remove</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Keys to remove after iteration</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">iterator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterators</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="n">remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">remove</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterators</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds the iterable to the pool&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;cannot add iterable to closed pool&quot;</span><span class="p">)</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterators</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">iterator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_key</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Closes all iterators in the pool&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">iterator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterators</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="s2">&quot;close&quot;</span><span class="p">):</span>
                <span class="n">iterator</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="c1"># - Experimental class to aid in scheduling stuff</span>

<span class="k">class</span> <span class="nc">_HeapQueue</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Heap of key-value pairs</span>

<span class="sd">    This is a small wrapper class over the heapq module specialized for</span>
<span class="sd">    schedulers.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; queue = _HeapQueue()</span>
<span class="sd">        &gt;&gt;&gt; queue.push(1, &quot;a&quot;)</span>
<span class="sd">        &gt;&gt;&gt; queue.push(2, &quot;b&quot;)</span>
<span class="sd">        &gt;&gt;&gt; queue.push(3, &quot;c&quot;)</span>
<span class="sd">        &gt;&gt;&gt; queue.first</span>
<span class="sd">        (1, &#39;a&#39;)</span>
<span class="sd">        &gt;&gt;&gt; queue.pop()</span>
<span class="sd">        (1, &#39;a&#39;)</span>
<span class="sd">        &gt;&gt;&gt; queue.push(5, &quot;d&quot;)</span>
<span class="sd">        &gt;&gt;&gt; queue.popleq(3)</span>
<span class="sd">        [(2, &#39;b&#39;), (3, &#39;c&#39;)]</span>
<span class="sd">        &gt;&gt;&gt; len(queue)</span>
<span class="sd">        1</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a heap queue&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heap</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heap</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> len=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds the key-value pair into the heap&quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_index</span>
        <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heap</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">first</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the key-value pair with the lowest key or raises ValueError</span>

<span class="sd">        If two pairs have the same key, the one pushed earlier will be</span>
<span class="sd">        returned.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;queue is empty&quot;</span><span class="p">)</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pops and returns the first pair or raises ValueError</span>

<span class="sd">        See .first for more info.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;queue is empty&quot;</span><span class="p">)</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heap</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">popleq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pops and returns a list of pairs less than or equal to key&quot;&quot;&quot;</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">self</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">first</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">pairs</span>


<span class="c1"># - Utilities wrapping sounddevice</span>

<div class="viewcode-block" id="play_output_chunks">
<a class="viewcode-back" href="../../api/soundit/#soundit.play_output_chunks">[docs]</a>
<span class="k">def</span> <span class="nf">play_output_chunks</span><span class="p">(</span><span class="n">chunks</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plays chunks to the default audio output device</span>

<span class="sd">    This is hardcoded to take PCM 16-bit 48kHz stereo audio, preferably in 20ms</span>
<span class="sd">    blocks.</span>

<span class="sd">    Keyword arguments are passed to sounddevice.RawOutputStream.</span>

<span class="sd">    Note that the sounddevice library is required for this function.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_sounddevice</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;sounddevice needed to play chunks&quot;</span><span class="p">)</span>
    <span class="n">SAMPLE_RATE</span> <span class="o">=</span> <span class="mi">48000</span>
    <span class="n">SECONDS_PER_CHUNK</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">//</span> <span class="mi">20</span>
    <span class="n">FRAMES_PER_CHUNK</span> <span class="o">=</span> <span class="n">SAMPLE_RATE</span> <span class="o">//</span> <span class="n">SECONDS_PER_CHUNK</span>
    <span class="k">with</span> <span class="n">sounddevice</span><span class="o">.</span><span class="n">RawOutputStream</span><span class="p">(</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="n">SAMPLE_RATE</span><span class="p">,</span>
        <span class="n">blocksize</span><span class="o">=</span><span class="n">FRAMES_PER_CHUNK</span><span class="p">,</span>
        <span class="n">channels</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int16&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="c1"># Using the specified blocksize is better for performance</span>
        <span class="n">buffer_len</span> <span class="o">=</span> <span class="n">FRAMES_PER_CHUNK</span> <span class="o">*</span> <span class="n">stream</span><span class="o">.</span><span class="n">samplesize</span> <span class="o">*</span> <span class="n">stream</span><span class="o">.</span><span class="n">channels</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">equal_chunk_stream</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="n">buffer_len</span><span class="p">):</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_input_chunks">
<a class="viewcode-back" href="../../api/soundit/#soundit.create_input_chunks">[docs]</a>
<span class="k">def</span> <span class="nf">create_input_chunks</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns chunks from the default audio input device</span>

<span class="sd">    This is hardcoded to yield 20ms blocks of PCM 16-bit 48kHz stereo audio.</span>

<span class="sd">    Keyword arguments are passed to sounddevice.RawInputStream.</span>

<span class="sd">    Note that the sounddevice library is required for this function.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_sounddevice</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;sounddevice needed to record chunks&quot;</span><span class="p">)</span>
    <span class="n">SAMPLE_RATE</span> <span class="o">=</span> <span class="mi">48000</span>
    <span class="n">SECONDS_PER_CHUNK</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">//</span> <span class="mi">20</span>
    <span class="n">FRAMES_PER_CHUNK</span> <span class="o">=</span> <span class="n">SAMPLE_RATE</span> <span class="o">//</span> <span class="n">SECONDS_PER_CHUNK</span>
    <span class="n">FRAMES_PER_CHUNK</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;blocksize&quot;</span><span class="p">,</span> <span class="n">FRAMES_PER_CHUNK</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">sounddevice</span><span class="o">.</span><span class="n">RawInputStream</span><span class="p">(</span>
        <span class="n">samplerate</span><span class="o">=</span><span class="n">SAMPLE_RATE</span><span class="p">,</span>
        <span class="n">blocksize</span><span class="o">=</span><span class="n">FRAMES_PER_CHUNK</span><span class="p">,</span>
        <span class="n">channels</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;channels&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int16&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">overflowed</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">FRAMES_PER_CHUNK</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">data</span></div>



<span class="c1"># - Miscellaneous sound utilities</span>

<span class="k">def</span> <span class="nf">_dft</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">frequency</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">cmath</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">frequency</span> <span class="o">/</span> <span class="n">n</span>
    <span class="n">rect_</span> <span class="o">=</span> <span class="n">cmath</span><span class="o">.</span><span class="n">rect</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="n">rect_</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="p">)</span> <span class="o">/</span> <span class="n">n</span>

<span class="k">def</span> <span class="nf">_fft_inplace</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes the Fast Fourier Transform in-place</span>

<span class="sd">    The length of points must be a power of two. Pass False to invert to</span>
<span class="sd">    calculate the inverse.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Resources:</span>
    <span class="c1"># https://cp-algorithms.web.app/algebra/fft.html</span>
    <span class="c1"># https://jakevdp.github.io/blog/2013/08/28/understanding-the-fft/</span>
    <span class="c1"># https://www.youtube.com/watch?v=r6sGWTCMz2k</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="c1"># Ensure the array is a power of 2 so we can achieve O(n log n) performance</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;list length must be a power of 2&quot;</span><span class="p">)</span>
    <span class="c1"># Faster lookup</span>
    <span class="n">range_</span> <span class="o">=</span> <span class="nb">range</span>
    <span class="n">rect_</span> <span class="o">=</span> <span class="n">cmath</span><span class="o">.</span><span class="n">rect</span>
    <span class="c1"># Bit reversal permutation</span>
    <span class="n">half_n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">range_</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">half_n</span>
        <span class="k">while</span> <span class="n">j</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">^=</span> <span class="n">mask</span>
            <span class="n">mask</span> <span class="o">//=</span> <span class="mi">2</span>
        <span class="n">j</span> <span class="o">^=</span> <span class="n">mask</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">:</span>
            <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="c1"># Iterative Fast Fourier Transform</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="o">-</span><span class="n">cmath</span><span class="o">.</span><span class="n">pi</span> <span class="k">if</span> <span class="n">invert</span> <span class="k">else</span> <span class="n">cmath</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">wlen</span> <span class="o">=</span> <span class="n">rect_</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">direction</span> <span class="o">/</span> <span class="n">size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">range_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">0</span><span class="n">j</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">range_</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">size</span><span class="p">):</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="n">size</span><span class="p">]</span> <span class="o">*</span> <span class="n">w</span>
                <span class="n">points</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span> <span class="o">+</span> <span class="n">v</span>
                <span class="n">points</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span> <span class="o">-</span> <span class="n">v</span>
                <span class="n">w</span> <span class="o">*=</span> <span class="n">wlen</span>
        <span class="n">size</span> <span class="o">*=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
            <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">n</span>


<span class="c1"># - Meta utilities</span>

<div class="viewcode-block" id="reload">
<a class="viewcode-back" href="../../api/soundit/#soundit.reload">[docs]</a>
<span class="k">def</span> <span class="nf">reload</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reloads this module. Helper function&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">importlib</span>
    <span class="n">name</span> <span class="o">=</span> <span class="vm">__name__</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">importlib</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">))</span></div>



<span class="c1"># - Built-in music</span>

<div class="viewcode-block" id="MUSIC_DIGITIZED">
<a class="viewcode-back" href="../../api/soundit/#soundit.MUSIC_DIGITIZED">[docs]</a>
<span class="n">MUSIC_DIGITIZED</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1"># names=&quot;do di re ri mi fa fi so si la li ti&quot;.split()</span>
<span class="s1"># offset=1</span>
<span class="s1"># line_length=1.15</span>

<span class="s1">. mi mi mi</span>
<span class="s1">fa do . do</span>
<span class="s1">. so mi do</span>
<span class="s1">re mi,re - mi</span>

<span class="s1">la3 mi mi mi</span>
<span class="s1">fa do . do</span>
<span class="s1">. so mi do</span>
<span class="s1">re mi,re - mi</span>

<span class="s1">do mi mi mi</span>
<span class="s1">fa do . do</span>
<span class="s1">. so mi do</span>
<span class="s1">re mi,re - mi</span>

<span class="s1">la3 la3 la3 fa3</span>
<span class="s1">fa3 fa3 fa3 fa3</span>
<span class="s1">do do do so3</span>
<span class="s1">so3 so3 si3 si3</span>

<span class="s1">la3 la3 la3 fa3</span>
<span class="s1">fa3 fa3 fa3 fa3</span>
<span class="s1">do do do so3</span>
<span class="s1">la3,do,mi,so la,do5,mi5,so5 la5 .</span>

<span class="s1">do so mi do</span>
<span class="s1">re re,mi so mi</span>
<span class="s1">do so mi do</span>
<span class="s1">re re,mi so re</span>

<span class="s1">do so mi do</span>
<span class="s1">re re,mi so mi</span>
<span class="s1">do so mi do</span>
<span class="s1">re re,mi so re</span>

<span class="s1">- do . la3</span>
<span class="s1">. la3 do re</span>
<span class="s1">so3 do mi do</span>
<span class="s1">re do,re - do</span>

<span class="s1">- do . la3</span>
<span class="s1">. la3 do re</span>
<span class="s1">so3 do mi do</span>
<span class="s1">re do,re - do</span>

<span class="s1">do la3 - so3</span>
<span class="s1">do re,mi - re</span>
<span class="s1">. . do so3</span>
<span class="s1">re mi re do</span>

<span class="s1">. . do so3</span>
<span class="s1">fa mi,re - do</span>
<span class="s1">- so3 re do</span>
<span class="s1">mi so re do</span>

<span class="s1">la3 mi mi mi</span>
<span class="s1">fa do . do</span>
<span class="s1">. so mi do</span>
<span class="s1">re mi,re - mi</span>

<span class="s1">do mi mi mi</span>
<span class="s1">fa do . do</span>
<span class="s1">. so mi do</span>
<span class="s1">re mi,re - mi</span>

<span class="s1">la3 la3 la3 fa3</span>
<span class="s1">fa3 fa3 fa3 fa3</span>
<span class="s1">do do do so3</span>
<span class="s1">so3 so3 si3 si3</span>

<span class="s1">la3 la3 la3 fa3</span>
<span class="s1">fa3 fa3 fa3 fa3</span>
<span class="s1">do do do so3</span>
<span class="s1">la3,do,mi,so la,do5,mi5,so5 la5 .</span>

<span class="s1">do so mi do</span>
<span class="s1">re re,mi so mi</span>
<span class="s1">do so mi do</span>
<span class="s1">re re,mi so re</span>

<span class="s1">do so mi do</span>
<span class="s1">re re,mi so mi</span>
<span class="s1">do so mi do</span>
<span class="s1">re re,mi so re</span>

<span class="s1">- do . la3</span>
<span class="s1">. la3 do re</span>
<span class="s1">so3 do mi do</span>
<span class="s1">re do,re - do</span>

<span class="s1">- do . la3</span>
<span class="s1">. la3 do re</span>
<span class="s1">so3 do mi do</span>
<span class="s1">re do,re - -</span>

<span class="s1">do</span>
<span class="s1">&#39;&#39;&#39;</span></div>


<div class="viewcode-block" id="MUSIC_MEGALOVANIA">
<a class="viewcode-back" href="../../api/soundit/#soundit.MUSIC_MEGALOVANIA">[docs]</a>
<span class="n">MUSIC_MEGALOVANIA</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1"># names=&quot;do di re ri mi fa fi so si la li ti&quot;.split()</span>
<span class="s1"># offset=6</span>
<span class="s1"># line_length=2.2</span>

<span class="s1">la3 la3 la - mi - - ri - re - do - la3 do re</span>
<span class="s1">so3 so3 la - mi - - ri - re - do - la3 do re</span>
<span class="s1">fi3 fi3 la - mi - - ri - re - do - la3 do re</span>
<span class="s1">fa3 fa3 la - mi - - ri - re - do - la3 do re</span>

<span class="s1">la3 la3 la - mi - - ri - re - do - la3 do re</span>
<span class="s1">so3 so3 la - mi - - ri - re - do - la3 do re</span>
<span class="s1">fi3 fi3 la - mi - - ri - re - do - la3 do re</span>
<span class="s1">fa3 fa3 la - mi - - ri - re - do - la3 do re</span>

<span class="s1">do - do do - do - do - la3 - la3 - - - -</span>
<span class="s1">do - do do - re - ri - re do la3 do re - -</span>
<span class="s1">do - do do - re - ri - mi - so - mi - -</span>
<span class="s1">la - la - la mi la so - - - - - - - -</span>

<span class="s1">mi - mi mi - mi - mi - re - re - - - -</span>
<span class="s1">mi - mi mi - mi - re - mi - so - mi re -</span>
<span class="s1">la do mi do so do mi do re do re mi so mi re do</span>
<span class="s1">la3 - ti3 - do la3 do so - - - - - - - -</span>

<span class="s1">la3 - - - - - - - do la3 do re ri re do la3</span>
<span class="s1">do la3 do - re - - - - - - - - - re mi</span>
<span class="s1">la - re mi re do ti3 la3 do - re - mi - so -</span>
<span class="s1">la - la - la mi la so - - - - - - - -</span>

<span class="s1">do - re - mi - do5 - ti - - - si - - -</span>
<span class="s1">ti - - - do5 - - - re5 - - - ti - - -</span>
<span class="s1">mi5 - - - - - - - mi5 ti so re do ti3 la3 si3</span>
<span class="s1">so3 - - - - - - - si3 - - - - - - -</span>

<span class="s1">mi3 - - - - - - - - - - - do - - -</span>
<span class="s1">ti3 - - - - - - - si3 - - - - - - -</span>
<span class="s1">la3</span>
<span class="s1">-</span>
<span class="s1">&#39;&#39;&#39;</span></div>


<span class="c1"># Use split_music to separate top and bottom parts</span>
<div class="viewcode-block" id="MUSIC_DIGITIZED_DUAL">
<a class="viewcode-back" href="../../api/soundit/#soundit.MUSIC_DIGITIZED_DUAL">[docs]</a>
<span class="n">MUSIC_DIGITIZED_DUAL</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    # names=&quot;do di re ri mi fa fi so si la li ti&quot;.split()</span>
<span class="s1">    # line_length=4.36</span>
<span class="s1">    # offset=13</span>
<span class="s1">/   # offset=1</span>

<span class="s1">    . mi mi mi fa       do . do .           so mi do re         mi,re - mi</span>
<span class="s1">/   .</span>

<span class="s1">    la3 mi mi mi        fa do . do          . so mi do          re mi,re - mi</span>
<span class="s1">/   la3 la3 la3 fa3     fa3 fa3 fa3 fa3     do do do so3        so3 so3 si3 si3</span>

<span class="s1">    do mi mi mi         fa do . do          . so mi do          re mi,re - mi</span>
<span class="s1">/   la3 la3 la3 fa3     fa3 fa3 fa3 fa3     do do do so3        so3 so3 si3 si3</span>

<span class="s1">    do mi mi mi         fa do . do          . so mi do          re mi,re - mi</span>
<span class="s1">/   la3 la3 la3 la3     la3 la3 la3 la3     la3 la3 la3 la3     la3 la3 la3 la3</span>

<span class="s1">    do mi mi mi         fa do . do          . so mi do          . . . .</span>
<span class="s1">/   la3 la3 la3 la3     la3 la3 la3 la3     la3 la3 la3 la3     la3,do,mi,so la,do5,mi5,so5 la5 .</span>

<span class="s1">    do so mi do         re re,mi so mi      do so mi do         re re,mi so re</span>
<span class="s1">/   la3 la3 la3 fa3     fa3 fa3 fa3 fa3     do do do so3        so3 so3 si3 si3</span>

<span class="s1">    do so mi do         re re,mi so mi      do so mi do         re re,mi so re</span>
<span class="s1">/   la3 la3 la3 fa3     fa3 fa3 fa3 fa3     do do do so3        so3 so3 si3 si3</span>

<span class="s1">    - do . la3          . la3 do re         so3 do mi do        re do,re - do</span>
<span class="s1">/   la3 la3 la3 fa3     fa3 fa3 fa3 fa3     do do do so3        so3 so3 si3 si3</span>

<span class="s1">    - do . la3          . la3 do re         so3 do mi do        re do,re - do</span>
<span class="s1">/   la3 la3 la3 fa3     fa3 fa3 fa3 fa3     do do do so3        so3 so3 si3 si3</span>

<span class="s1">    do la3 - so3        do re,mi - re       . . do so3          re mi re do</span>
<span class="s1">/   .</span>

<span class="s1">    . . do so3          fa mi,re - do       - so3 re do         mi so re do</span>
<span class="s1">/   .</span>

<span class="s1">    la3 mi mi mi        fa do . do          . so mi do          re mi,re - mi</span>
<span class="s1">/   la3 . la3 .         fa3 . fa3 .         do . do .           so3 . so3 .</span>

<span class="s1">    do mi mi mi         fa do . do          . so mi do          re mi,re - mi</span>
<span class="s1">/   la3 . la3 .         fa3 . fa3 .         do . do .           so3 . so3 .</span>

<span class="s1">    do mi mi mi         fa do . do          . so mi do          re mi,re - mi</span>
<span class="s1">/   la3 la3 la3 fa3     fa3 fa3 fa3 fa3     do do do so3        so3 so3 si3 si3</span>

<span class="s1">    do mi mi mi         fa do . do          . so mi do          . . . .</span>
<span class="s1">/   la3 la3 la3 fa3     fa3 fa3 fa3 fa3     do do do so3        la3,do,mi,so la,do5,mi5,so5 la5 .</span>

<span class="s1">    do so mi do         re re,mi so mi      do so mi do         re re,mi so re</span>
<span class="s1">/   la3 la3 la3 fa3     fa3 fa3 fa3 fa3     do do do so3        so3 so3 si3 si3</span>

<span class="s1">    do so mi do         re re,mi so mi      do so mi do         re re,mi so re</span>
<span class="s1">/   la3 la3 la3 fa3     fa3 fa3 fa3 fa3     do do do so3        so3 so3 si3 si3</span>

<span class="s1">    - do . la3          . la3 do re         so3 do mi do        re do,re - do</span>
<span class="s1">/   la3 la3 la3 fa3     fa3 fa3 fa3 fa3     do do do so3        so3 so3 si3 si3</span>

<span class="s1">    - do . la3          . la3 do re         so3 do mi do        re do,re - -</span>
<span class="s1">/   la3 la3 la3 fa3     fa3 fa3 fa3 fa3     do do do so3        so3 so3 si3 si3</span>

<span class="s1">    do . . .</span>
<span class="s1">/   la3 . . .</span>
<span class="s1">&#39;&#39;&#39;</span>  <span class="c1"># noqa: E501</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2021, GeeTransit
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link" href="https://github.com/GeeTransit/soundit" aria-label="On GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
              </a>
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=751a5dd3"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=32e29ea5"></script>
    </body>
</html>